<template lang="html">
    <div id="cart" >
        <header-common :title="viewTitle" :iconType="iconType" :rightParams="rightParams"></header-common>
        <div class="cartWrap carTop">
            <div class="CarInfo iconfont icon-chevron-copy-copy-copy-copy-copy-copy" @click="$router.push('/user/changeCurCar')">
                <div class="CarInfoWrap">
                    <div class="carLogo">
                        <img src="../assets/images/test_carlogo.png" >
                    </div>
                    <div class="carInfo">
                        <div class="carID">{{defaultCar.displayLicensePlate}}</div>
                        <div class="carDesc">{{defaultCar.carName}}</div>
                    </div>
                </div>
            </div>

            <div class="scroll" ref="scroll">
                <div class="scrollBar">
                    <div class="content">
                        <div class="tt" @click="onAddServe()"><i class="iconfont icon-combinedshape"></i>添加服务项目</div>
                    </div>
                    <div class="content project-store" v-for="item in relCartData.serviceShoppingCartItems">
                        <div class="tt">
                            <i class="iconfont icon-xuanze" :class="{ 'sel': item.sel }" @click="serveSelect(item)"></i>{{item.serviceProductName}}
                            <span class="desc">耗时<em>{{item.duration}}小时</em>服务费<em>￥{{item.price}}</em></span>
                        </div>
                        <div class="item" v-for="itemchild in item.accessoryCategories">
                            <p class="ttl">
                                <span class="name">{{itemchild.accessoryCategoryName}}</span>
                            </p>
                            <p class="ttl2">
                                <span class="desc" v-for="pj in itemchild.accessoryShoppingCartItems"><label class="descName">{{pj.accessoryProductName}} <em v-if="pj.quantity>1">x{{pj.quantity}}</em></label> <label class="descPrice">￥{{pj.accessoryProductUnitPrice}}</label></span>
                            </p>
                            <!-- <p class="cost">￥1222</p> -->
                            <p class="change" @click="onChangePJ(itemchild.accessoryCategoryId, item.serviceProductId, item.serviceShoppingCartItemId)">更换<span class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></p>
                        </div>
                        <div class="serveStore">
                            <p class="ttl" v-if="item.serviceTypeId === 2">
                                <span class="name">{{item.storeName }}</span>
                                <span class="desc">{{item.storeDetailAddress }}</span>
                            </p>
                            <p class="ttl" v-else="item.serviceTypeId === 1">
                                <span class="name" style="height:56px;line-height:56px">尚门理车上门服务</span>
                            </p>
                            <p class="change" @click="onChangeStore(item.serviceShoppingCartItemId)">更换<span class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="totalWrap">
                <div class="left">
                    <span class="iconfont icon-xuanze" :class="{ sel: checkAll}" @click="checkALLfun"></span>全选
                </div>
                <div class="right">
                    <div class="hj">
                        合计：<span>￥{{totalPrice}}</span><br>
                        <p>共{{totalServeNum}}项服务</p>
                    </div>
                    <div class="buy" @click="onCartConform()">下单</div>
                </div>
            </div>
        </div>
        <orderConfirm v-if="confirmShow" :selectArr="selectArr" :selectCartData="selectCartData" v-on:closeConfirmInParent="closeConfirmIt"></orderConfirm>
        <div class="cartmask" v-if="cartmask"></div>
    </div>
</template>

<script  type="text/ecmascript-6">
import Bscroll from 'better-scroll'
import headerCommon from 'components/header/headerCommon.vue'
import orderConfirm from './../views/orderConfirm.vue'
import { Toast, MessageBox } from 'mint-ui'
import ajax from './../vueResource.ajax.js'

export default {
    data () {
        return {
            viewTitle: '购物车',
            iconType: '',
            rightParams: {
                path: '/cartCompile',
                desc: '编辑'
            },
            // 购物车数据
            relCartData: {},
            // 全选
            checkAll: false,
            // 总价
            totalPrice: 0,
            // 购物车服务总数
            totalServeNum: 0,
            // confirm开关
            confirmShow: false,
            // 选中的ID数组
            selectArr: [],
            // 选中的数组
            selectCartData: [],
            // 遮罩隐显
            cartmask: false
        }
    },
    components: {
        'header-common': headerCommon,
        'orderConfirm': orderConfirm
    },
    created () {
        this.$nextTick(function () {
            // this._initScroll()
        })
        if (this.$store.state.user.userDefaultCar.id) {
            this.getCartData()
        } else {
            this.getDefaultCarInfo()
        }
    },
    activated () {
        if (this.$store.state.user.userDefaultCar.id) {
            this.getCartData()
        } else {
            this.getDefaultCarInfo()
        }
    },
    computed: {
        cartData () {
            this.getTotal()
            return this.$store.state.cart.cartData
        },
        defaultCar () {
            return this.$store.state.user.userDefaultCar
        }
    },
    watch: {
        cartData () {
            // console.log(this.cartData)
            this.relCartData = this.cartData
        }
    },
    methods: {
        closeConfirmIt () {
            this.confirmShow = false
            this.cartmask = false
            // this.checkAll = false
        },
        _initScroll () {
            this.viewScroll = new Bscroll(this.$refs.scroll, {
                click: true,
                scrollY: true
            })
        },
        onAddServe () {
            this.$router.push('/serve/index')
        },
        onChangeStore (sid) {
            this.$router.push('/serveStore?sid=' + sid)
        },
        onChangePJ (id, pid, sid) {
            // sid 购物车服务ID
            this.$router.push('/cartAccessories?id=' + id + '&pid=' + pid + '&sid=' + sid)
        },
        // 获取选择的服务的总价格 和 服务数量
        getTotal () {
            var dat = this.$store.state.cart.cartData.serviceShoppingCartItems
            if (dat) {
                this.totalPrice = 0
                this.totalServeNum = 0
                // this.totalServeNum = dat.length
                for (var i = 0; i < dat.length; i++) {
                    if (dat[i].sel) {
                        this.totalPrice += dat[i].subToal * 100
                        this.totalServeNum += 1
                    }
                }
                this.totalPrice = this.totalPrice / 100
            }
        },
        onCartConform () {
            var dat = this.cartData.serviceShoppingCartItems
            var arr = []
            for (var i = 0; i < dat.length; i++) {
                if (dat[i].sel) {
                    arr.push(dat[i].serviceShoppingCartItemId)
                    this.selectCartData.push(dat[i])
                }
            }
            if (arr.length <= 0) {
                Toast('请至少选择一项服务')
                return false
            }
            // var urlParam = arr.join('|')
            // this.$router.push('/orderConfirm?sel=' + urlParam)
            this.selectArr = arr
            this.confirmShow = true
            this.cartmask = true
        },
        checkALLfun () {
            this.checkAll = !this.checkAll
            // cartData
            console.log(this.cartData)
            var dat = this.cartData.serviceShoppingCartItems
            for (var i = 0; i < dat.length; i++) {
                dat[i].sel = this.checkAll
            }
            this.getTotal()
        },
        serveSelect (val) {
            var dat = this.cartData.serviceShoppingCartItems
            for (var i = 0; i < dat.length; i++) {
                if (dat[i].serviceShoppingCartItemId === val.serviceShoppingCartItemId) {
                    dat[i].sel = !val.sel
                    if (dat[i].sel === false) {
                        this.checkAll = false
                    }
                     this.cartData = dat
                     this.getTotal()
                    // console.log(this.cartData.serviceShoppingCartItems)
                    return
                }
            }
        },
        // 获取购物车数据
        getCartData () {
            ajax.ajax({
                'vue': this,
                'port': 'GetShoppingCart',
                'type': 'get',
                'params_url': '?customerCarId=' + this.defaultCar.id,
                'statusOk': function (res, v) {
                    console.log(res.data.data)
                    var dat = res.data.data.serviceShoppingCartItems
                    for (var i = 0; i < dat.length; i++) {
                        dat[i].sel = false
                    }
                    v.$store.state.cart.cartData = res.data.data
                },
                'statusError': function (res, v) {
                    Toast('获取购物车列表失败')
                }
            })
        },
        getDefaultCarInfo () {
            if (!this.$store.state.user.curCarNum) {
                ajax.ajax({
                    'vue': this,
                    'port': 'GetDefaultCustomerCar',
                    'type': 'get',
                    'statusOk': function (res, v) {
                        v.$store.state.user.userDefaultCar = res.data.data
                        v.$store.state.user.curCarNum = v.$store.state.user.userDefaultCar.displayLicensePlate
                        v.getCartData()
                    },
                    'statusError': function (res, v) {
                        if (!res.data.data) {
                            // var Promise = MessageBox.confirm('您需要先添加车辆信息<br>是否现在添加?').then(action => {
                            //     v.$router.push('/user/addCarInfo')
                            // })
                            MessageBox.alert('您需要先添加车辆信息').then(action => {
                                v.$router.push('/user/addCarInfo')
                            });
                        }
                    }
                })
            } else {
                var listData = this.$store.state.user.userCarList
                var curCarID = this.$store.state.user.curCarData.id
                for (var i = 0; i < listData.length; i++) {
                    if (listData[i].id === curCarID) {
                        this.$store.state.user.userDefaultCar = listData[i]
                        v.getCartData()
                    }
                }
            }
        }
    },
    beforeCreate () {
        this.$store.commit('showFoot')
    }
}
</script>

<style lang="stylus" rel="stylesheet/stylus">
@import '../assets/css/cssCommon.styl'
#cart
    .cartWrap
        padding-top:45px
        .CarInfo
            position:fixed
            top:45px
            z-index:2
            .carDesc
                height:16px
        .scroll
            /*position:absolute*/
            top:141px
            bottom:100px
            width:100%
            overflow:hidden
            padding-bottom:110px
            padding-top:100px
        .content
            margin-bottom:10px
            background-color:#fff
            border-bottom:1px solid #ddd
            .tt
                line-height:50px
                padding-left:12px
                color:#666
                border-bottom:1px solid #ddd
                font-size:18px
                margin-bottom:-1px
                .desc
                    color:#999
                    font-size:15px
                    float:right
                    padding-right:10px
                    em
                        color:#c7a770
                        font-style:normal
                        font-family:'微软雅黑'
                        &:first-child
                            margin-right:5px
                i
                    margin-right:5px
                    display:inline-block
                    padding:0
                    &:before
                        color:#999
                        font-size:24px
                        vertical-align:middle
                .sel
                    &:before
                        color:#c7a770
            .item
                margin-left:42px
                overflow:hidden
                border-bottom:1px solid #ddd
                /*display:table*/
                position:relative
                min-height:60px
                &:last-child
                    border:none
                p
                    line-height:58px
                    float:left
                .cost
                    font-family:'微软雅黑'
                .ttl
                    width:58%
                    span
                        display:block
                        white-space:nowrap
                        overflow:hidden
                        text-overflow:ellipsis
                        overflow:hidden
                        &:first-child
                            margin-top:2px
                            line-height:30px
                            height:30px
                .ttl2
                    width:75%
                    padding-bottom:10px
                    span
                        display:block
                        height:18px
                        line-height:18px
                        font-size:14px
                        color:#999
                        label
                            display:inline-block
                            em
                                font-style:normal
                        .descName
                            width:65%
                        .descPrice
                            width:30%
                .change
                    float:right
                    color:#c7a770
                    /*display:table-cell
                    vertical-align:middle*/
                    position:absolute
                    top:0
                    right:0
                    span
                        color:#999
                        margin-left:5px
            .serveStore
                line-height:55px
                overflow:hidden
                padding-left:12px
                border-top:1px solid #ddd
                margin-top:-1px
                p
                    float:left
                    .name
                        display:block
                        font-size:18px
                        margin-top:2px
                        line-height:30px
                    .desc
                        font-size:15px
                        color:#999
                        display:block
                        line-height:20px
                        height:20px
                        white-space:nowrap
                        overflow:hidden
                        text-overflow:ellipsis
                        overflow:hidden
                .ttl
                    width:75%
                    overflow:hidden
                .change
                    float:right
                    color:#c7a770
                    span
                        margin-left:10px
                        color:#999
        .totalWrap
            position:fixed
            width:100%
            height:50px
            bottom:50px
            left:0
            background-color:#f5f5f5
            border-top:1px solid #ddd
            .left
                float:left
                line-height:50px
                padding-left:12px
                color:#333
                span
                    font-size:24px
                    vertical-align:middle
                    color:#999
                    margin-right:5px
                .sel
                    color:#c7a770
            .right
                height:50px
                float:right
                position:relative
                padding-right:107px
                .buy
                    position:absolute
                    top:7px
                    right:12px
                    display:inline-block
                    width:90px
                    height:36px
                    line-height:36px
                    text-align:center
                    background-color:#c7a770
                    color:#fff
                .hj
                    margin-top:8px
                    span
                        color:#c7a770
                    p
                        font-size:14px
                        margin-top:2px
    .cartmask
        position:fixed
        width:100%
        height:100%
        background-color:#f5f5f5
        z-index:100
        top:0
        left:0

</style>
