<template lang="html">
    <!-- 服务介绍 -->
    <div id="serveIntroduce">
        <header-common :title="viewTitle" :iconType="iconType" :rightParams="rightParams"></header-common>
        <div class="serveIntroduceWrap">
            <div class="top">
                <img :src="serveData.servicePictureUrl? serveData.servicePictureUrl : '../../assets/images/test1.png'" />
                <p><span>{{serveData.name}}</span><span>耗时<em>{{serveData.duration? serveData.duration : '-' }}小时</em>服务费<em>￥{{serveData.price? serveData.price : '-'}}</em></span></p>
            </div>
            <div class="content">
                <h2>服务内容</h2>
                <div class="desc" v-html="serveData.fullDescription? serveData.fullDescription : '无' "></div>
            </div>
            <div class="content">
                <h2>服务评价</h2>
                <div class="comment">
                    <div class="list" v-for="item in serveCommmData">
                        <img :src="item.customerPictureUrl" class="headImg">
                        <div class="info">
                            <p class="p1"><span class="name">{{item.customerMobile}}</span><span class="time">{{item.createdOn}}</span></p>
                            <p class="grade">
                                <i class="iconfont icon-xing" :class="{'sel': item.serviceProductRating >= 1}"></i>
                                <i class="iconfont icon-xing" :class="{'sel': item.serviceProductRating >= 2}"></i>
                                <i class="iconfont icon-xing" :class="{'sel': item.serviceProductRating >= 3}"></i>
                                <i class="iconfont icon-xing" :class="{'sel': item.serviceProductRating >= 4}"></i>
                                <i class="iconfont icon-xing" :class="{'sel': item.serviceProductRating >= 5}"></i>
                            </p>
                            <p class="commentDesc">
                                {{item.reviewText }}
                            </p>
                        </div>
                    </div>
                    <div class="moreComm" @click="getMoreComm">查看更多</div>
                </div>
            </div>
            <div class="btnWrap">
                <!-- <button @click="$router.push('/appointment')">预约服务</button> -->
                <button @click="onAddCart()">加入购物车</button>
            </div>
        </div>
    </div>
</template>

<script>
import headerCommon from '../../components/header/headerCommon.vue'
import ajax from './../../vueResource.ajax.js'

export default {
    data () {
        return {
            viewTitle: '服务介绍',
            iconType: 'icon-fanhui',
            rightParams: {},
            serveData: {},
            // 服务评价
            serveCommmData: []
        }
    },
    components: {
        'header-common': headerCommon
    },
    created () {
        ajax.ajax({
            'vue': this,
            'port': 'GetServiceProductDetail',
            'type': 'get',
            'params_url': '?serviceProductId=' + this.$route.params.id,
            'statusOk': function (res, v) {
                v.serveData = res.data.data
            },
            'statusError': function (res, v) {
                // Toast('获取用户信息失败')
            }
        })
        this.getCommData()
        this.getDefaultCarInfo()
    },
    computed: {
        defaultCar () {
            return this.$store.state.user.userDefaultCar
        }
    },
    beforeCreate () {
        this.$store.commit('hideFoot')
    },
    methods: {
        getMoreComm () {
            this.$router.push('/serveComm?id=' + this.$route.params.id)
        },
        onAddCart () {
            var params = {
                customerCarId: this.defaultCar.id,
                serviceProductId: this.$route.params.id,
                countyId: this.$store.state.user.curAreaID,
                longitude: window.sessionStorage.lng,
                latitude: window.sessionStorage.lat
            }
            ajax.ajax({
                'vue': this,
                'port': 'AddServiceProductToCart',
                'type': 'post',
                'req_params': params,
                'statusOk': function (res, v) {
                    var tmpdata = res.data.data
                    window.$.PageDialog.ok('添加服务成功')
                    // console.log(tmpdata)
                    v.updateCart()
                },
                'statusError': function (res, v) {
                    window.$.PageDialog.ok(res.data.errorMessage)
                }
            })
        },
        // 获取评论
        getCommData () {
            // serveCommmData
            ajax.ajax({
                'vue': this,
                'port': 'GetServiceProductReviews',
                'type': 'get',
                'params_url': '?serviceProductId=' + this.$route.params.id + '&dto.page=1&dto.pageSize=10',
                'statusOk': function (res, v) {
                    var dat = res.data.data
                    for (var i = 0; i < dat.length; i++) {
                        var date = new Date(dat[i].createdOn)
                        var month = parseInt(date.getMonth()) + 1
                        var hours = date.getHours() > 8? date.getHours() - 8: 24 + date.getHours() -8
                        var minutes = date.getMinutes() >= 10?date.getMinutes():'0'+date.getMinutes()
                        var seconds = date.getSeconds() >= 10?date.getSeconds():'0'+date.getSeconds()
                        dat[i].createdOn = date.getFullYear() + '-' + month + '-' + date.getDate() + ' ' + hours +':'+ minutes +':'+ seconds
                    }
                    v.serveCommmData = dat
                },
                'statusError': function (res, v) {
                    // Toast('获取用户信息失败')
                }
            })
        },
        getDefaultCarInfo () {
            if (!this.$store.state.user.userDefaultCar.id) {
                ajax.ajax({
                    'vue': this,
                    'port': 'GetDefaultCustomerCar',
                    'type': 'get',
                    'statusOk': function (res, v) {
                        v.$store.state.user.userDefaultCar = res.data.data
                        v.$store.state.user.curCarNum = v.$store.state.user.userDefaultCar.displayLicensePlate
                        // console.log(v.$store.state.user.userDefaultCar.id)
                    },
                    'statusError': function (res, v) {
                        if (!res.data.data) {
                            MessageBox.confirm('您需要先添加车辆信息<br>是否现在添加?').then(action => {
                                v.$router.push('/user/addCarInfo')
                            })
                        }
                    }
                })
            } else {
                var listData = this.$store.state.user.userCarList
                var curCarID = this.$store.state.user.curCarID
                if (!curCarID) {
                    console.log(this.$store.state.user.userDefaultCar.id)
                    curCarID =this.$store.state.user.userDefaultCar.id
                }
                console.log(listData.length)
                for (var i = 0; i < listData.length; i++) {
                    if (listData[i].id === curCarID) {
                        this.$store.state.user.userDefaultCar = listData[i]
                    }
                }
            }
        }
    }
}
</script>

<style lang="stylus" rel="stylesheet/stylus">
#serveIntroduce
    .serveIntroduceWrap
        padding-top:45px
        padding-bottom:65px
        .top
            border-bottom:1px solid #ddd
            padding:10px 10px 0 10px
            background-color:#fff
            img
                width:100%
            p
                line-height:45px
                overflow:hidden
                span
                    &:first-child
                        font-size:18px
                        color:#333
                    &:last-child
                        font-size:14px
                        color:#999
                        float:right
                        em
                             font-style:normal
                             font-family:'微软雅黑'
                             margin-right:3px
                             color:#dab96e
         .content
             padding:0 10px 10px 10px
             background-color:#fff
             margin-top:10px
             border-bottom:1px solid #ddd
             h2
                 line-height:45px
                 border-bottom:1px solid #ddd
                 margin-bottom:10px
            .desc
                text-indent:2rem
                color:#999
                line-height:20px
            .comment
                .list
                    position:relative
                    padding-left:60px
                    min-height:100px
                    border-bottom:1px solid #ddd
                    &:last-child
                        border:none
                    .headImg
                        width:50px
                        height:50px
                        position:absolute
                        left:5px
                        top:5px
                        border-radius:100%
                    .info
                        .p1
                            padding-top:10px
                            .name
                                color:#333
                            .time
                                color:#999
                                font-size:14px
                                float:right
                        .grade
                            padding-top:10px
                            color:#bfbfbe
                            font-size:13px
                            .sel
                                color:#ffb400
                        .commentDesc
                            padding-top:10px
                            padding-bottom:10px
            .moreComm
                text-align:center
                line-height:45px
        .btnWrap
            position:fixed
            bottom:0
            width:100%
            height:55px
            padding-top:5px
            border-top:1px solid #ddd
            background-color:#fff
            button
                border:none
                width:96%
                height:45px
                color:#fff
                font-size:16px
                display:block
                margin-left:2%
                float:left
                &:first-child
                    background-color:#c7a770
                /*&:last-child
                    background-color:#353535*/


</style>
