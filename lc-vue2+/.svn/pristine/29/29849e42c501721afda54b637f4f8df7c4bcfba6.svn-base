<template lang="html">
    <div id="payment" >
        <header-common :title="viewTitle" :iconType="iconType" :rightParams="rightParams"></header-common>
        <div class="paymentWrap">
            <div class="itemWrap" v-for="item in showData.orders">
                <div class="ttl">{{item.serviceTypeName}}</div>
                <p class="storeName" v-if="item.serviceTypeId === 2">{{item.storeName}}</p>
                <p class="group iconfont icon-chevron-copy-copy-copy-copy-copy-copy" @click="$router.push('/order/'+item.orderId)">
                    <span class="item"><label v-for="(fw, index) in item.serviceNames">{{fw}}{{index===item.serviceNames.length-1?'':'、'}}</label></span><span>共{{item.accessoryProductCount }}件配件、{{item.serviceCount}}项服务</span>
                </p>
                <!-- <p class="cost">支付金额：<em>￥65</em></p> -->
            </div>
            <!-- <div class="itemWrap">
                <div class="ttl">上门服务</div>
                <p class="group iconfont icon-chevron-copy-copy-copy-copy-copy-copy">
                    <span class="item">定期小保养、刹车片深化养护</span><span>共4件配件、2项服务</span>
                </p>
                <p class="cost">支付金额：<em>￥65</em></p>
            </div> -->
            <div class="itemWrap">
                <p class="cost">支付金额：<em>￥{{showData.payAmount}} <label>({{orderType==='false'||!orderType?'订金':'尾款'}})</label> </em></p>
            </div>
            <div class="balance">可用账户余额<em>￥{{userInfo.balance}}</em><mt-switch v-model="isUsebalance"></mt-switch></div>
            <div class="itemWrap payList" v-if="!isUsebalance">
                <div class="ttl">支付方式</div>
                <!-- 1-支付宝,2-微信支付,4-银联支付,8-余额支付 -->
                <div class="payType weixin" @click="select(1)"><span class="payIcon"><img src="../assets/images/icon_zhifubao.png" alt=""></span><span class="payName">支付宝</span><span class="iconfont icon-39 " :class="payType === 1?'icon-xuanze':''"></span></div>
                <div class="payType weixin" @click="select(2)"><span class="payIcon"><img src="../assets/images/icon_weixin.png" alt=""></span><span class="payName">微信</span><span class="iconfont icon-39" :class="payType === 2?'icon-xuanze':''"></span></div>
                <!-- <div class="payType weixin" @click="select(4)"><span class="payIcon"><img src="../assets/images/icon_yinlian.png" alt=""></span><span class="payName">银联</span><span class="iconfont icon-39" :class="payType === 4?'icon-xuanze':''"></span></div> -->
            </div>
            <div class="btnWrap" >
                <button @click="paymentNow()">确认支付</button>
            </div>
        </div>
    </div>
</template>

<script  type="text/ecmascript-6">
import headerCommon from 'components/header/headerCommon.vue'
import { Toast, Switch } from 'mint-ui'
import ajax from './../vueResource.ajax.js'

export default {
    data () {
        return {
            viewTitle: '在线支付',
            iconType: 'icon-fanhui',
            rightParams: {},
            // 1 支付宝 2 微信 4 银联
            payType: 1,
            // 订单状态
            orderType: false,
            // 是否使用余额
            isUsebalance: false,
            // 展示数据
            showData: []
        }
    },
    components: {
        'header-common': headerCommon,
        'mt-switch': Switch
    },
    created () {
        this.orderType = this.$route.query.orderType
        this.getOrderInfo()
        if (!this.userInfo.balance) {
            this.getUserInfo()
        }
    },
    computed: {
        userInfo () {
            return this.$store.state.user.userInfo
        }
    },
    methods: {
        select (type) {
            this.payType = type
        },
        // 1-支付宝,2-微信支付,4-银联支付,8-余额支付
        paymentNow () {
            this.orderType = this.$route.query.orderType
            var orderId = this.$route.query.orderId
            window.sessionStorage.curPaymentOrderID =  orderId
            if (this.orderType === 'true') {
                // 尾款
                // console.log('尾款')
                this.finalPay()
            } else {
                // 订金
                // console.log('订金')
                this.subscriptionPay()
            }
        },
        // 支付订金
        subscriptionPay () {
            var orderId = this.$route.query.orderId.split(',')
            var type
            if (this.isUsebalance === true) {
                type = 8
            } else {
                type = this.payType
            }

            ajax.ajax({
                'vue': this,
                'port': 'PayOrder',
                'type': 'post',
                'req_params': {orderIds:orderId,payTypeId:type},
                'statusOk': function (res, v) {
                    // console.log(res.data.data)
                    var ua = v.userAgent()
                    if (ua === 'android') {
                        if (type === 1) {
                            var obj = {
                                type: '101',
                                value: res.data.data
                            }
                            var str = JSON.stringify(obj)
                            myJsObj.pay(str)
                        } else if (type ===2) {
                            // myJsObj.pay('{"type":"102","value":'+res.data.data+'}')
                            var obj = {
                                type: '102',
                                value: res.data.data
                            }
                            var str = JSON.stringify(obj)
                            myJsObj.pay(str)
                        } else if (type === 4) {
                        } else if (type === 8) {
                            if (res.data.data === 'success') {
                                v.$router.push('/paySuccess')
                            } else {
                                window.$.PageDialog.ok('支付失败')
                            }
                        }
                    } else if (ua === 'ios') {
                        if (type === 1) {
                            var dat2 = res.data.data
                            window.webkit.messageHandlers.HybridKit.postMessage({"method": "pay", "param": {"type":"101","value":dat2}})
                        } else if (type ===2) {
                            var dat = JSON.parse(res.data.data)
                            window.webkit.messageHandlers.HybridKit.postMessage({"method": "pay", "param": {"type":"102","value":dat}})
                        } else if (type === 4) {
                        } else if (type === 8) {
                            if (res.data.data === 'success') {
                                v.$router.push('/paySuccess')
                            } else {
                                window.$.PageDialog.ok('支付失败')
                            }
                        }
                    }
                },
                'statusError': function (res, v) {
                    window.$.PageDialog.ok('支付失败')
                }
            })
        },
        // 支付尾款
        finalPay () {
            var orderId = this.$route.query.orderId
            var type
            if (this.isUsebalance === true) {
                type = 8
            } else {
                type = this.payType
            }
            // console.log({orderIds:orderId,payTypeId:this.payType})
            ajax.ajax({
                'vue': this,
                'port': 'FinalPayOrder',
                'type': 'post',
                'req_params': {orderId:orderId,payTypeId:type},
                'statusOk': function (res, v) {
                    // console.log(res.data.data)
                    var ua = v.userAgent()
                    if (ua === 'android') {
                        if (type === 1) {
                            var obj = {
                                type: '101',
                                value: res.data.data
                            }
                            var str = JSON.stringify(obj)
                            myJsObj.pay(str)
                        } else if (type ===2) {
                            // myJsObj.pay('{"type":"102","value":'+res.data.data+'}')
                            var obj = {
                                type: '102',
                                value: res.data.data
                            }
                            var str = JSON.stringify(obj)
                            myJsObj.pay(str)
                        } else if (type === 4) {
                        } else if (type === 8) {
                            if (res.data.data === 'success') {
                                v.$router.push('/paySuccess')
                            } else {
                                window.$.PageDialog.ok('支付失败')
                            }
                        }
                    } else if (ua === 'ios') {
                        if (type === 1) {
                            var dat2 = res.data.data
                            window.webkit.messageHandlers.HybridKit.postMessage({"method": "pay", "param": {"type":"101","value":dat2}})
                        } else if (type ===2) {
                            var dat = JSON.parse(res.data.data)
                            window.webkit.messageHandlers.HybridKit.postMessage({"method": "pay", "param": {"type":"102","value":dat}})
                        } else if (type === 4) {
                        } else if (type === 8) {
                            if (res.data.data === 'success') {
                                v.$router.push('/paySuccess')
                            } else {
                                window.$.PageDialog.ok('支付失败')
                            }
                        }
                    }
                },
                'statusError': function (res, v) {
                    window.$.PageDialog.ok('支付失败')
                }
            })
        },
        // 获取支付页面订单数据
        getOrderInfo () {
            var orderId = this.$route.query.orderId.split(',')
            ajax.ajax({
                'vue': this,
                'port': 'PrePayInfo',
                'type': 'post',
                'req_params': {orderIds:orderId},
                'statusOk': function (res, v) {
                    // console.log(res.data.data)
                    v.showData = res.data.data
                },
                'statusError': function (res, v) {
                }
            })
        },
        userAgent() {
            var ua = navigator.userAgent.toLowerCase()
            var _ua = ""
            if (/iphone|ipad|ipod/.test(ua)) {
                _ua = "ios"
            } else if (/android/.test(ua)) {
                _ua = "android"
            }else{
                _ua = "web"
            }
            return _ua
        },
        getUserInfo () {
            ajax.ajax({
                'vue': this,
                'port': 'MyInfo',
                'type': 'get',
                'statusOk': function (res, v) {
                    v.$store.commit('setUserInfo', res.data.data)
                },
                'statusError': function (res, v) {
                    // Toast('获取用户信息失败')
                }
            })
        }
    },
    beforeCreate () {
        this.$store.commit('hideFoot')
    }
}
</script>

<style lang="stylus" rel="stylesheet/stylus">
#payment
    .paymentWrap
        padding-top:45px
        padding-bottom:74px
        .itemWrap
            .ttl
                line-height:40px
                padding-left:10px
                background-color:#f5f5f5
            p
                background-color:#fff
                padding-left:10px
                border-bottom:1px solid #ddd
            .storeName
                height:50px
                line-height:50px
            .group
                height:55px
                line-height:55px
                position:relative
                span
                    display:block
                    overflow:hidden
                    white-space:nowrap
                    overflow:hidden
                    text-overflow:ellipsis
                    height:20px
                    line-height:20px
                    font-size:14px
                    color:#999
                .item
                    font-size:16px
                    line-height:28px
                    height:28px
                    color:#333
                    width:94%
                &:before
                    position:absolute
                    right:2px
            .cost
                color:#999
                font-size:16px
                line-height:50px
                border-bottom:1px solid #ddd
                label
                    font-size:14px
                em
                    font-size:20px
                    color:#c7a770
                    font-style:normal
                    font-family:'微软雅黑'
            .payType
                line-height:50px
                position:relative
                margin-left:40px
                border-bottom:1px solid #ddd
                &:last-child
                    border-bottom:none
                .payIcon
                    position:absolute
                    padding:0 12px
                    left:-45px
                    img
                        width:30px
                        height:30px
                        vertical-align:middle
                .iconfont
                    font-size:24px
                    color:#999
                    float:right
                    margin-right:10px
                .icon-xuanze
                    color:#c7a770
        .balance
            margin-top:10px
            background-color:#fff
            line-height:50px
            padding-left:12px
            border-bottom: 1px solid  #ddd
            .mint-switch
                float:right
                margin:9px 10px 0 0
                .mint-switch-core
                    border-color:#c7a770
                    background-color:#c7a770
            em
                margin-left:15px
                color:#c7a770
                font-style:normal
                font-family:'微软雅黑'
        .payList
            border-bottom:1px solid #ddd
            background-color:#fff

        .btnWrap
            position: fixed
            bottom: 0
            width: 100%
            background-color: #fff
            z-index: 2
            button
                width: 94%
                margin: 20px 3% 10px 3%
                background-color: #c7a770
                height: 44px
                line-height: 44px
                color: #fff
                border: none
                font-size: 18px

</style>
