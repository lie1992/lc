<template lang="html">
    <!-- 选择车型 -->
    <div id="series">
        <header-float :title="viewTitle" :iconType="iconType" :rightParams="rightParams" :hideNode="hideNode"></header-float>
        <div class="seriesWrap">
            <mt-index-list>
                <mt-index-section v-for="item in finalData" :index="item.en">
                    <div class="list" v-for="node in item.list" @click="onShowfloatWrap(node)">
                        <img :src="node.pictureUrl" >{{node.name}}
                    </div>
                </mt-index-section>
            </mt-index-list>
        </div>
        <div class="floatWrap" v-if="isShow == 'ok'">
            <div class="floatcon left iconfont icon-doubleup-copy1" @click="onCloseFloatWrap"></div>
            <div class="floatcon right">
                <div class="car_type_name">
					<img :src="img"><div>{{carName}}</div>
				</div>
                <div class="slider" ref="scrollBar">
                    <div class="listWrap">
                        <div v-for="item in carSeriesList" :brandId="item.brandId">
                            <p :id="item.id">{{item.name}}</p>
                            <ul>
                                <li v-for="ser in item.series" :id="ser.id"  @click="onSelectPattern(ser.id)">
                                    {{ser.name}}
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <carSelectPattern v-if="$store.state.comm.hasCarSelectParternSHow" :parternId="parternId"></carSelectPattern>
    </div>

</template>

<script>
import headerFloat from '../components/header/headerFloat.vue'
import carSelectPattern from './carSelectPattern.vue'
import { IndexList, IndexSection, Toast } from 'mint-ui'
// import pinyin from 'pinyin'
// import pinyin from './../../static/js/web-pinyin.js'
import Bscroll from 'better-scroll'
import ajax from './../vueResource.ajax.js'

export default {
    data () {
        return {
            viewTitle: '选车车型',
            iconType: 'icon-fanhui',
            rightParams: {},
            // 请求的车品牌数据
            series: [],
            // 英文字母数组
            enData: [],
            // 最终的数据
            finalData: [],
            // 是否开启浮层
            isShow: 'no',
            // 品牌车系列表
            carSeriesList: [],
            // 隐藏车辆选择
            hideNode: 'hideCarSelect',
            // 车款ID
            parternId: '',
            // 选车图片
            img: '',
            // 选车名字
            carName: ''
        }
    },
    components: {
        'header-float': headerFloat,
        'mt-index-list': IndexList,
        'mt-index-section': IndexSection,
        'carSelectPattern': carSelectPattern
    },
    beforeCreate () {
        this.$store.commit('hideFoot')
        // 测试
        // this.$http.get('/api/series').then((res) => {
        //     this.series = res.body.data
        // }, (res) => {
        // })
        ajax.ajax({
            'vue': this,
            'port': 'GetBrands',
            'type': 'get',
            'statusOk': function (res, v) {
                v.series = res.body.data
            },
            'statusError': function (res, v) {
                Toast('获取车辆品牌失败')
            }
        })
    },
    created () {
    },
    watch: {
        series: function (n, o) {
            console.log(n)
            var vm = this
            // 获取首字母列表
            var newData = vm.getLetter(n)
            var EnList = newData.EnList
            var CnList = newData.CnList
            // 复制数组，断开索引链接，否则series一直处于变化状态
            var AllList = newData.AllData.slice(0)
            this.enData = newData.EnList
            const pinyinData = CnList.map(han => ({
                han: han,
                pinyin: window.pinyin(han)[0][0]
            }))
            const sortedData = pinyinData.sort((a, b) => {
                return a.pinyin.localeCompare(b.pinyin)
            }).map(d => d.han)

            var AllData = this.getAllData(sortedData, AllList)
            this.finalData = this.getFinalData(EnList, AllData)
            console.log(this.finalData)
        }
    },
    methods: {
        _initScroll () {
            this.viewScroll = new Bscroll(this.$refs.scrollBar, {
                click: true,
                scrollY: true
            })
        },
        onShowfloatWrap (node) {
            this.isShow = 'ok'
            console.log(node)
            this.img = node.pictureUrl
            this.carName = node.name
            ajax.ajax({
                'vue': this,
                'port': 'GetBrandSeriesAndSeries',
                'type': 'get',
                'params_url': '?brandId=' + node.id,
                'statusOk': function (res, v) {
                    v.carSeriesList = res.body.data
                    console.log(v.carSeriesList)
                },
                'statusError': function (res, v) {
                    Toast('获取车辆品牌失败')
                }
            })
            this.$nextTick(function () {
                this._initScroll()
            })
        },
        onCloseFloatWrap () {
            this.isShow = 'no'
        },
        onSelectPattern (id) {
            // this.$router.push('/selectPattern?id=1')
            this.parternId = id
            this.$store.state.comm.hasCarSelectParternSHow = true
        },
        // 获取字母列表
        getLetter (list) {
            var EnList = []
            var CnList = []
            for (var variable in list) {
                if (list[variable].name === '讴歌') {
                    list[variable].name = 'O讴歌'
                }
                if (list[variable].name !== '') {
                    CnList.push(list[variable].name)
                }
                var tmp = window.pinyin(list[variable].name, {
                    style: window.pinyin.STYLE_FIRST_LETTER,
                    heteronym: false,
                    segment: true
                })
                var firstStr = tmp[0]
                if (firstStr) {
                    // 配置识别不了的汉字

                    if (String(firstStr[0]).length > 1) {
                        firstStr[0] = String(firstStr[0]).charAt(0)
                    }

                    firstStr[0] = String(firstStr[0]).toUpperCase()

                    list[variable].en = firstStr[0]

                    if (EnList.indexOf(firstStr[0]) === -1) {
                        EnList.push(firstStr[0])
                    }
                }
            }
            EnList = EnList.sort()
            return {
                'EnList': EnList,
                'CnList': CnList,
                'AllData': list
            }
        },
        // 获取完整数据
        getAllData (cndata, val) {
            // 先对alldata进行排序
            var newList = []
            for (var i in cndata) {
                for (var j in val) {
                    if (val[j].name === cndata[i]) {
                        newList[i] = val[j]
                        continue
                    }
                }
            }
            return newList
        },
        // 获取最终数据
        getFinalData (endata, data) {
            var list = []
            var tmp = {}
            for (var carval in data) {
                // console.log(enval)
                // if (carval.en === enval) {
                //     arr.list.push(carval)
                // }
                if (data[carval].en) {
                    if (list.length > 0) {
                        var hasEn = false
                        for (var num in list) {
                            if (list[num].en === data[carval].en) {
                                list[num].list.push(data[carval])
                                hasEn = true
                                break
                            }
                        }
                        if (!hasEn) {
                            tmp = {}
                            tmp.en = data[carval].en
                            tmp.list = []
                            tmp.list.push(data[carval])
                            list.push(tmp)
                        }
                    } else {
                        tmp = {}
                        tmp.en = data[carval].en
                        tmp.list = []
                        tmp.list.push(data[carval])
                        list.push(tmp)
                    }
                }
            }
            return list
        }
    }
}
</script>

<style lang="stylus" rel="stylesheet/stylus">
#series
    position:absolute
    width:100%
    z-index:1001
    top:0
    left:0
    min-height:100%
    .seriesWrap
        background-color:#fff
        position:absolute
        top:45px
        bottom:0
        width:100%
        .mint-indexlist
            .mint-indexlist-content
                width:100%
                .mint-indexsection
                    .mint-indexsection-index
                        padding:7px 10px
                        background-color:#f5f5f5
                        border:1px solid #ccc
                        border-right:none
                        border-left:none
                    ul
                        .list
                            padding:7px 7px 7px 0
                            margin-left:7px
                            height:50px
                            line-height:50px
                            border-bottom:1px solid #ccc
                            img
                                vertical-align:middle
                                height:50px
                                height:50px
                                margin-right:10px
                            &:last-child
                                border:none
            .mint-indexlist-nav
                width:30px
                background:none
                border:none
                justify-content:initial
                ul
                    li
                        padding:4px 6px
    .floatWrap
        position:fixed
        top:45px
        left:0
        bottom:0
        width:100%
        .floatcon
            float:left
            height:100%
        .left
            background-color:rgba(0,0,0,0.5)
            width:20%
            position:relative
            font-size:18px
            &:before
                position:absolute
                top:42%
                left:50%
                margin-left:-7px
                color:#fff
        .right
            background-color:#fff
            width:80%
            .car_type_name
                height: 50px
                line-height: 50px
                border-bottom: 1px solid #ccc
                font-size:18px
                img
                    width: 40px
                    height: 40px
                    margin: 5px
                    float: left
                div
                    float: left
            .slider
                /*height:100%*/
                overflow:hidden
                position:absolute
                top:51px
                bottom:0
                width:100%
                .listWrap
                    p
                        line-height: 35px
                        padding: 0 10px
                        border-bottom: 1px solid #ccc
                        background: #f5f5f5
                        color: #989898
                        font-size: 14px
                    ul
                        border-bottom:1px solid #ccc
                        li
                            height: 60px
                            line-height: 60px
                            border-bottom: 1px solid #ccc
                            background: #fff
                            font-size:18px
                            margin-left:10px
                            &:last-child
                                border:none

</style>
