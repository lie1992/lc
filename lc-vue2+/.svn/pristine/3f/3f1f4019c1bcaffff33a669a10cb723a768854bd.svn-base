<template lang="html">
    <div id="orderConfirm" >
        <header-common :title="viewTitle" :iconType="iconType" :rightParams="rightParams" :paths="close" v-on:closeConfirm="closeConfirmReal"></header-common>
        <div class="orderConfirmWrap ">
            <div class="orderItemWrap" v-if="SMdata.preOrderServiceShoppingCartItems && SMdata.preOrderServiceShoppingCartItems.length > 0">
                <div class="att">上门服务</div>
                <div class="content project-store" >
                    <!-- v-for="item in SMdata.preOrderServiceShoppingCartItems" -->
                    <div v-for="fw in SMdata.preOrderServiceShoppingCartItems">
                        <div class="tt">
                            {{fw.serviceProductName}}
                            <span class="desc" @click="toggleItemSM(fw)">耗时<em>{{fw.duration}}小时</em>服务费<em>￥{{fw.price}}</em><i class="iconfont" :class="{ 'icon-chevron-copy-copy-copy': fw.show, 'icon-chevron-copy-copy-copy-copy-copy': !fw.show}"></i></span>
                        </div>
                        <div class="item" :class="{ hiden: fw.show }" v-for="itemchild in fw.accessoryCategories">
                            <p class="ttl">
                                <span class="name">{{itemchild.accessoryCategoryName}}</span>
                            </p>
                            <p class="ttl2">
                                <span class="desc" v-for="pj in itemchild.accessoryShoppingCartItems"><label class="descName">{{pj.accessoryProductName}} <em v-if="pj.quantity>1">x{{pj.quantity}}</em></label> <label class="descPrice">￥{{pj.accessoryProductSubTotalPrice}}</label></span>
                            </p>
                            <!-- <p class="change" @click="onChangePJ()">更换<span class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></p> -->
                        </div>
                    </div>
                    <div class="serveStore commonWrap" @click="addressToggle = true, cartmask = true">
                        <p class="ttl" v-if="SMdata.addressCustomerName">
                            <span class="name">{{SMdata.addressCustomerName}}        {{SMdata.addressPhoneNumber}}</span>
                            <span class="desc">{{SMdata.addressDetails}}</span>
                        </p>
                        <p class="ttl" v-else>
                            <span class="selAddress">请选择上门服务地址</span>
                        </p>
                        <p class="change" @click=""><span class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></p>
                    </div>
                    <div class="appointment commonWrap"  @click="onChangeYY(1, SMdata.SMDur, SMdata.addressId)">
                        <p class="ttl">
                            <span class="nm">预约时间</span>
                            <span class="cont">{{SMdata.YY?SMdata.YY:'请选择预约时间'}}</span>
                        </p>
                        <p class="change"><span class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></p>
                    </div>
                    <div class="discount commonWrap" @click="onChangeYHQ(1)">
                        <p class="ttl">
                            <span class="nm">优惠券</span>
                            <span class="cont" v-if="SMdata && SMdata.discountName">{{SMdata.discountName}}</span>
                            <span class="nodisc" v-if="!SMdata.discountName">请选择优惠券</span>
                        </p>
                        <p class="change" ><span class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></p>
                    </div>
                    <div class="total">
                        共{{SMdata.preOrderServiceShoppingCartItems.length}}项服务 小计：<em>￥{{SMdata.total}}</em>
                    </div>
                </div>
            </div>
            <div class="orderItemWrap" v-if="MDdata.length > 0">
                <div class="att">门店服务</div>
                <div class="content project-store" v-for="item in MDdata">
                    <div v-for="fw in item.preOrderServiceShoppingCartItems" >
                        <div class="tt">
                            {{fw.serviceProductName}}
                            <span class="desc" @click="toggleItem(fw)">耗时<em>{{fw.duration}}小时</em>服务费<em>￥{{fw.price}}</em><i class="iconfont" :class="{ 'icon-chevron-copy-copy-copy': fw.show, 'icon-chevron-copy-copy-copy-copy-copy': !fw.show}"></i></span>
                        </div>
                        <div class="item" :class="{ hiden: fw.show }" v-for="itemchild in fw.accessoryCategories">
                            <p class="ttl">
                                <span class="name">{{itemchild.accessoryCategoryName}}</span>
                            </p>
                            <p class="ttl2">
                                <span class="desc" v-for="pj in itemchild.accessoryShoppingCartItems"><label class="descName">{{pj.accessoryProductName}} <em v-if="pj.quantity>1">x{{pj.quantity}}</em></label> <label class="descPrice">￥{{pj.accessoryProductSubTotalPrice}}</label></span>
                            </p>
                            <!-- <p class="change" @click="onChangePJ()">更换<span class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></p> -->
                        </div>
                    </div>
                    <div class="serveStore commonWrap">
                        <p class="ttl">
                            <span class="name">{{item.storeName }}</span>
                            <span class="desc">{{item.storeAddress?item.storeAddress:'商家未配置地址' }}</span>
                        </p>
                        <!-- <p class="change" @click="onChangeYY()"><span class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></p> -->
                    </div>
                    <div class="appointment commonWrap" @click="onChangeYY(2, item.MDDur, item.addressId, item.storeId)">
                        <p class="ttl">
                            <span class="nm">预约时间</span>
                            <span class="cont">{{item.YY?item.YY:'请选择预约时间'}}</span>
                        </p>
                        <p class="change" ><span class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></p>
                    </div>
                    <div class="discount commonWrap" @click="onChangeYHQ(2, item.storeId)">
                        <p class="ttl">
                            <span class="nm">优惠券</span>
                            <span class="cont" v-if="item.discountName">{{item.discountName}}</span>
                            <span class="nodisc" v-if="!item.discountName">请选择优惠券</span>
                        </p>
                        <p class="change"><span class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></p>
                    </div>
                    <div class="total">
                        共{{item.preOrderServiceShoppingCartItems.length}}项服务 小计：<em>￥{{item.total}}</em>
                    </div>
                </div>
            </div>

            <!-- <div class="ticket">发票<div class="switchBtn"><mt-switch v-model="examineValue"></mt-switch></div></div> -->
            <div class="tips">提交后理车秘书会在24小时内与您联系</div>
            <div class="atotal">应付订金：<em>￥{{$store.state.cart.cartConfirmDJ}}</em><button @click="placeOrder()">提交</button></div>
        </div>
        <appointment v-if="YYToggle" :YYType="YYType" :YYServeID="YYServeID" :YYDur="YYDur" :YYAddressID="YYAddressID" v-on:closeYYInParent="closeYYInParentReal"></appointment>
        <changeAddressInCart v-if="addressToggle" v-on:closeAddressParent="closeAddressParentReal"></changeAddressInCart>
        <changeDiscount v-if="discountToggle" :selectArr="selectArr" :discountServeID="discountServeID" :discountServeType="discountServeType" v-on:closeYHQInParent="closeDiscountReal"></changeDiscount>
        <div class="cartmask" v-if="cartmask"></div>
    </div>
</template>

<script  type="text/ecmascript-6">
import headerCommon from 'components/header/headerCommon.vue'
import appointment from './../views/serve/appointment.vue'
import changeAddressInCart from './../views/user/changeAddressInCart.vue'
import changeDiscount from './../views/user/changeDiscount.vue'
import { Switch, Toast } from 'mint-ui'
import ajax from './../vueResource.ajax.js'

export default {
    props: {
        selectArr: {
            type: Array
        },
        selectCartData: {
            type: Array
        }
    },
    data () {
        return {
            viewTitle: '确认订单',
            iconType: 'icon-fanhui',
            rightParams: {
                path: 'close',
                closeEmit: 'closeConfirm'
            },
            close: 'close',
            examineValue: false,
            // 确认购物车数据
            realData:[],
            // 上门数据
            // SMdata: [],
            SMprice: 0,
            // 门店数据
            // MDdata: [],
            MDprice: 0,
            // 总价
            totalPrice: 0,
            addressData: {},
            // 预约toggle
            YYToggle: false,
            // 选择地址toggle
            addressToggle: false,
            // 优惠券toggle
            discountToggle: false,
            // 优惠券选择的服务ID
            discountServeID: '',
            // 优惠券选择的服务type
            discountServeType: '',
            // 预约类型
            YYType: 1,
            // 预约时长
            YYDur: 0,
            // 预约地址ID
            YYAddressID: 0,
            // 遮罩隐显
            cartmask: false,
            // 预约ID
            YYServeID: 0,
            // 应付定金
            totalDJ: 0
        }
    },
    components: {
        'header-common': headerCommon,
        'mt-switch': Switch,
        'appointment': appointment,
        'changeAddressInCart': changeAddressInCart,
        'changeDiscount': changeDiscount
    },
    computed: {
        cartData () {
            return this.$store.state.cart.cartData
        },
        defaultCar () {
            return this.$store.state.user.userDefaultCar
        },
        SMdata () {
            return this.$store.state.cart.cartConfirmSMData
        },
        MDdata () {
            return this.$store.state.cart.cartConfirmMDData
        }
    },
    created () {
        window.scroll(0,0)
        this.getConfirmData()
    },
    methods: {
        // 关闭确认组件（自己）
        closeConfirmReal () {
            this.$store.state.cart.discountSeledList = []
            // this.selectArr = []
            this.$emit('closeConfirmInParent')
        },
        // 关闭地址组件
        closeAddressParentReal () {
            this.addressToggle = false
            this.cartmask = false
        },
        // 关闭预约时间
        closeYYInParentReal () {
            this.YYToggle = false
            this.cartmask = false
        },
        // 关闭折扣券
        closeDiscountReal () {
            // console.log('关闭折扣券')
            this.discountToggle = false
            this.cartmask = false
        },
        // 选择预约时间
        onChangeYY (type, dur, addressId,sid) {
            // console.log(type, dur)
            this.YYType = type
            this.YYDur = dur
            this.YYAddressID = addressId
            if (sid) {
                this.YYServeID = sid
            }
            this.YYToggle = true
            this.cartmask = true
        },
        onChangeYHQ (type, storeId) {
            // console.log(type, storeId)
            this.discountServeID = storeId,
            this.discountServeType = type
            this.discountToggle = true
            this.cartmask = true
        },
        getConfirmData () {

            var nparam = {
                "storeShoppingCarts": [],
                "doorToDoorShoppingCart": {},
                // 当前车辆ID
                "customerCarId": this.defaultCar.id,
                // 购物车选中的服务
                "shoppingCartItemIds": this.selectArr
            }
            // console.log(this.selectCartData)
            var tmp = {}
            for (var i = 0; i < this.selectCartData.length; i++) {
                if (this.selectCartData[i].serviceTypeId === 2) {
                    tmp = {
                        "storeId": this.selectCartData[i].storeId,
                        "couponId": '',
                        "appointment": ''
                    }
                    nparam.storeShoppingCarts.push(tmp)
                } else {
                    nparam.doorToDoorShoppingCart = {
                        "addressId": '',
                        "couponId": '',
                        "appointment": ''
                    }
                }
            }
            // console.log(nparam)
            ajax.ajax({
                'vue': this,
                'port': 'BuildPreOrder',
                'type': 'post',
                'req_params': nparam,
                'statusOk': function (res, v) {
                    console.log(res.data.data)
                    var dat = res.data.data
                    v.totalDJ = res.data.data.totalDepositAmount
                    var MDDur = 0
                    var SMDur = 0
                    for (var i = 0; i < dat.storePreOrders.length; i++) {
                        var tmp = dat.storePreOrders[i]
                        tmp.discountID = ''
                        tmp.discountName = ''
                        MDDur = 0
                        for (var j = 0; j < tmp.preOrderServiceShoppingCartItems.length; j++) {
                            tmp.preOrderServiceShoppingCartItems[j].show = false
                            MDDur += tmp.preOrderServiceShoppingCartItems[j].duration
                        }
                        tmp.MDDur = MDDur
                        tmp.YY = ''
                    }
                    if (dat.doorToDoorPreOrder && dat.doorToDoorPreOrder.preOrderServiceShoppingCartItems) {
                        for (var i = 0; i < dat.doorToDoorPreOrder.preOrderServiceShoppingCartItems.length; i++) {
                            var tmp = dat.doorToDoorPreOrder.preOrderServiceShoppingCartItems[i]
                            tmp.show = false
                            SMDur += tmp.duration
                        }
                        dat.doorToDoorPreOrder.SMDur = SMDur
                        dat.doorToDoorPreOrder.discountID = ''
                        dat.doorToDoorPreOrder.discountName = ''
                        dat.doorToDoorPreOrder.YY = ''
                        v.YYAddressID = dat.doorToDoorPreOrder.addressId
                        v.$store.state.cart.cartConfirmSMData = dat.doorToDoorPreOrder
                    } else {
                        v.$store.state.cart.cartConfirmSMData = {}
                    }
                    v.$store.state.cart.cartConfirmMDData = dat.storePreOrders
                    v.$store.state.cart.cartConfirmDJ = dat.totalDepositAmount
                },
                'statusError': function (res, v) {
                    // Toast('获取购物车列表失败')
                    window.$.PageDialog.ok(res.data.errorMessage)
                    setTimeout(function() {
                        v.closeConfirmReal()
                    },1000)
                }
            })
        },
        toggleItem (val) {
            val.show = !val.show
        },
        toggleItemSM (val) {
            val.show = !val.show
        },
        // 下单
        placeOrder () {
            console.log(this.$store.state.cart.cartConfirmSMData)
            console.log(this.$store.state.cart.cartConfirmMDData)
            var SMdata = this.$store.state.cart.cartConfirmSMData
            var MDdata = this.$store.state.cart.cartConfirmMDData
            var params = {}
            // var params = {
            //     // 门店
            //     "storeShoppingCarts": [
            //         {
            //             // 门店ID
            //             "storeId": 0,
            //             // 优惠券ID
            //             "couponId": 0,
            //             // 预约时间
            //             "appointment": "2017-02-14T02:31:26.274Z"
            //         }
            //     ],
            //     // 用户的车辆Id
            //     "customerCarId": 0,
            //     // 购物车中选中的服务ID
            //     "shoppingCartItemIds": [
            //         0
            //     ],
            //     // 上门
            //     "doorToDoorShoppingCart": {
            //         // 地址
            //         "addressId": 0,
            //         // 优惠券
            //         "couponId": 0,
            //         // 预约时间
            //         "appointment": "2017-02-14T02:31:26.274Z"
            //     }
            // }
            if (SMdata.addressId && !SMdata.YY) {
                window.$.PageDialog.ok('请选择上门服务预约时间')
                return false
            }
            params.doorToDoorShoppingCart = {
                addressId: SMdata.addressId,
                couponId: SMdata.discountID,
                appointment: SMdata.YY
            }
            params.customerCarId = this.defaultCar.id
            params.shoppingCartItemIds = this.selectArr
            var tmp = {
                // 门店ID
                "storeId": 0,
                // 优惠券ID
                "couponId": 0,
                // 预约时间
                "appointment": "2017-02-14T02:31:26.274Z"
            }
            params.storeShoppingCarts = []
            for (var i = 0; i < MDdata.length; i++) {
                tmp.storeId = MDdata[i].storeId
                tmp.couponId = MDdata[i].discountID
                tmp.appointment = MDdata[i].YY
                params.storeShoppingCarts.push(tmp)
            }
            // console.log(params)
            ajax.ajax({
                'vue': this,
                'port': 'PlaceOrder',
                'type': 'post',
                'req_params': params,
                'statusOk': function (res, v) {
                    console.log(res.data.data)
                    // Toast('提交订单成功')
                    v.selectArr = []
                    v.$router.push('/payment?orderId='+res.data.data)
                },
                'statusError': function (res, v) {
                }
            })
        },
        // ------------------------------------
        createConfirmData () {
            var idArr = this.$route.query.sel.split('|')
            if (this.cartData.serviceShoppingCartItems) {
                var dat = this.cartData.serviceShoppingCartItems
                for (var j = 0; j < idArr.length; j++) {
                    for (var i = 0; i < dat.length; i++) {
                        if (parseInt(dat[i].serviceShoppingCartItemId) === parseInt(idArr[j])) {
                            this.realData.push(dat[i])
                        }
                    }
                }
                if (this.realData.length > 0) {
                    for (var k = 0; k < this.realData.length; k++) {
                        if (this.realData[k].serviceTypeId === 2) {
                            this.MDdata.push(this.realData[k])
                            this.MDprice += this.realData[k].subToal
                        } else {
                            this.SMdata.push(this.realData[k])
                            this.SMprice += this.realData[k].subToal
                        }
                        // this.SMprice = this.SMprice / 100
                        // this.MDprice = this.MDprice / 100
                        this.totalPrice = (this.SMprice * 100 + this.MDprice * 100) / 100
                    }
                }
                console.log(this.realData)
            } else {
                this.getDefaultCarInfo()
            }
        },
        // 获取购物车数据
       getCartData () {
           ajax.ajax({
               'vue': this,
               'port': 'GetShoppingCart',
               'type': 'get',
               'params_url': '?customerCarId=' + this.defaultCar.id,
               'statusOk': function (res, v) {
                   // console.log(res.data.data)
                   var dat = res.data.data.serviceShoppingCartItems
                   v.$store.state.cart.cartData = res.data.data
                //    v.createConfirmData()
                      v.getConfirmData()
               },
               'statusError': function (res, v) {
                   window.$.PageDialog.ok('获取购物车列表失败')
               }
           })
       },
       getDefaultCarInfo () {
           if (!this.$store.state.user.curCarNum) {
               ajax.ajax({
                   'vue': this,
                   'port': 'GetDefaultCustomerCar',
                   'type': 'get',
                   'statusOk': function (res, v) {
                       v.$store.state.user.userDefaultCar = res.data.data
                       v.$store.state.user.curCarNum = v.$store.state.user.userDefaultCar.displayLicensePlate
                       v.getCartData()
                   },
                   'statusError': function (res, v) {
                    //    window.$.PageDialog.ok('获取用户信息失败')
                   }
               })
           } else {
               var listData = this.$store.state.user.userCarList
               var curCarID = this.$store.state.user.curCarData.id
               for (var i = 0; i < listData.length; i++) {
                   if (listData[i].id === curCarID) {
                       this.$store.state.user.userDefaultCar = listData[i]
                       v.getCartData()
                   }
               }
           }
       },
       getDefaultAddress () {

        //    ajax.ajax({
        //        'vue': this,
        //        'port': 'GetCustomerAddress',
        //        'type': 'get',
        //        'statusOk': function (res, v) {
           //
        //        },
        //        'statusError': function (res, v) {
        //            Toast('获取用户信息失败')
        //        }
        //    })
       }
    }
}
</script>

<style lang="stylus" rel="stylesheet/stylus">
#orderConfirm
    position:absolute
    z-index:101
    background-color:#f5f5f5
    top:0
    left:0
    width:100%
    height:100%
    .orderConfirmWrap
        padding-top:55px
        padding-bottom:55px
        background-color:#f5f5f5
        .orderItemWrap
            .att
                padding-left:12px
                line-height:20px
                height:30px
            .content
                margin-bottom:10px
                background-color:#fff
                border-bottom:1px solid #ddd
                .tt
                    line-height:25px
                    padding:15px 0
                    padding-left:12px
                    color:#666
                    border-bottom:1px solid #ddd
                    font-size:18px
                    margin-bottom:-1px
                    overflow:hidden
                    border-top:1px solid #ddd
                    .desc
                        color:#999
                        font-size:15px
                        float:right
                        padding-right:10px
                        i
                            &:before
                                margin-left:5px
                                font-size:16px
                        em
                            color:#c7a770
                            font-style:normal
                            font-family:'微软雅黑'
                    i
                        margin-right:5px
                        display:inline-block
                        padding:0
                        &:before
                            color:#999
                            font-size:24px
                            vertical-align:middle
                    .sel
                        &:before
                            color:#c7a770
                .hiden
                    display:none
                .item
                    margin-left:42px
                    overflow:hidden
                    border-bottom:1px solid #ddd
                    position:relative
                    min-height:60px
                    &:last-child
                        border:none
                    p
                        line-height:58px
                        float:left
                    .cost
                        font-family:'微软雅黑'
                    .ttl
                        width:58%
                        span
                            display:block
                            white-space:nowrap
                            overflow:hidden
                            text-overflow:ellipsis
                            overflow:hidden
                            &:first-child
                                margin-top:2px
                                line-height:30px
                                height:30px
                    .ttl2
                        width:75%
                        padding-bottom:10px
                        span
                            display:block
                            height:18px
                            line-height:18px
                            font-size:14px
                            color:#999
                            label
                                display:inline-block
                                float:left
                                em
                                    font-style:normal
                            .descName
                                width:65%
                                white-space:nowrap
                                overflow:hidden
                                text-overflow:ellipsis
                            .descPrice
                                width:30%
                    .change
                        float:right
                        color:#c7a770
                        position:absolute
                        top:0
                        right:0
                        span
                            color:#999
                            margin-left:5px
                .commonWrap
                    line-height:55px
                    overflow:hidden
                    padding-left:12px
                    border-top:1px solid #ddd
                    margin-top:-1px
                    p
                        float:left
                        .selAddress
                            line-height:55px
                        .name
                            display:block
                            font-size:16px
                            margin-top:2px
                            line-height:30px
                        .desc
                            font-size:15px
                            color:#999
                            display:block
                            line-height:20px
                            height:20px
                            white-space:nowrap
                            overflow:hidden
                            text-overflow:ellipsis
                            overflow:hidden
                        .nm
                            display:inline-block
                            font-size:16px
                            width:100px
                        .cont
                            display:inline-block
                            font-size:16px
                            color:#999
                        .nodisc
                            display:inline-block
                            font-size:14px
                            color:#999
                    .ttl
                        width:75%
                        overflow:hidden
                    .change
                        float:right
                        color:#c7a770
                        span
                            margin-left:10px
                            color:#999
                .total
                    line-height:50px
                    padding-left:12px
                    border-top:1px solid #ddd
                    text-align:right
                    padding-right:12px
                    em
                        color:#c7a770
                        font-style:normal
                        font-family:'微软雅黑'
        .ticket
            padding:0 12px
            height:50px
            line-height:50px
            background-color:#fff
            .switchBtn
                float:right
                margin-top:9px
                .mint-switch
                    .mint-switch-core
                        border-color: #c7a770
                        background-color: #c7a770
        .tips
            text-align:center
            font-size:13px
            line-height:20px
        .atotal
            position:fixed
            left:0
            bottom:0
            width:98%
            height:50px
            line-height:50px
            background-color:#fff
            padding:0 1%
            border-top:1px solid #ddd
            em
                color:#c7a770
                font-style:normal
                font-family:'微软雅黑'
            button
                display:inline-block
                width:90px
                height:36px
                line-height:36px
                text-align:center
                background-color:#c7a770
                color:#fff
                float:right
                border:none
                margin:7px 12px 0 0
                font-size:16px
    .cartmask
        position:fixed
        width:100%
        height:100%
        background-color:#f5f5f5
        z-index:100
        top:0
        left:0
</style>
