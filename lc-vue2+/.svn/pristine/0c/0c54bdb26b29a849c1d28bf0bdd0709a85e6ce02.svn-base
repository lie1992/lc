<template lang="html">
    <!--  添加车辆 -->
    <div id="addCarInfo">
        <header-common :title="viewTitle" :iconType="iconType" :rightParams="rightParams"></header-common>
        <div id="addCarInfoWrap">
            <div class="info">
                <div class="carName iconfont icon-chevron-copy-copy-copy-copy-copy-copy">
                    <label v-if="!$store.state.comm.addCarID" @click="$store.state.comm.hasCarSelectSHow = true">请选择车辆</label>
                    <p v-else  @click="$store.state.comm.hasCarSelectSHow = true">
                        <img :src="carData.seriesPictureUrl" />
                        <span>{{carData.fullName}}</span>
                    </p>
                </div>
                <div class="carNum">
                    <label>车牌号</label>
                    <div class="carNumWrap">
                        <span class="areaID" @click="onSelectAreaOpen">{{selArea}}</span>
                        <input type="text" @blur="onAreaInputBlur" @focus="onAreaInputFocus" @keyup="onAreaInputKeyup" v-model="areaNum">
                    </div>
                </div>
                <div class=""><label>车架号</label> <input type="text" placeholder="请填写" v-model="frameNumber" ></div>
            </div>
            <div class="info">
                <div class="rz">
                    <label @click="onOpen" >车主认证<i class="iconfont icon-wenhaoweiwanchengyanzheng"></i></label>
                    <span class="front">
                        <img v-if="cardURL1" :src="cardURL1" >
                        行驶证正面
                        <form method="post" ref="upload1">
                            <input type="file" name="file" @change="onUpload($refs.upload1, 1)">
                        </form>
                    </span>
                    <span class="behind">
                        <img v-if="cardURL2" :src="cardURL2" >
                        行驶证反面
                        <form method="post" ref="upload2">
                            <input type="file" name="file" @change="onUpload($refs.upload2, 2)">
                        </form>
                    </span>
                </div>
            </div>
            <div class="info">
                <div><label>总公里数</label> <input type="text" placeholder="请填写" v-model="mile" @keyup="onlySZ(1)"></div>
                <div><label>日行驶公里数</label> <input type="text" placeholder="请填写" v-model="mileData" @keyup="onlySZ(2)"></div>
            </div>
            <div class="info">
                <div class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy" @click="onOpenAreaPicker(0)">
                    <label>设置车险提醒</label><input type="text" readonly placeholder="请选择" v-model="insuranceModel">
                </div>
                <div class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy" @click="onOpenAreaPicker(1)">
                    <label>设置年检提醒</label><input type="text" readonly placeholder="请选择" v-model="inspectModel">
                </div>
            </div>
            <div class="btnWrap">
                <button class="charge" @click="onSubmit">保存</button>
            </div>

            <div class="sex-picker" v-if="hasAreaPicker == 0">
                <div class="mask"></div>
                <div class="pickWrap">
                    <div class="opwrap">
                        <span @click="onSelectAreaClose(1)">取消</span>
                        <span @click="onSelectAreaClose(0)">确定</span>
                    </div>
                    <mt-picker :slots="slots"  @change="onAreaChange"></mt-picker>
                </div>
            </div>
            <mt-datetime-picker ref="picker" type="date" :startDate="startDate" @confirm="confirmDatePicker" @cancel="closeDataPicker" > </mt-datetime-picker>
        </div>
        <div class="uploadExp" v-if="$store.state.comm.carFloor">
            <header-float :title="viewTitle" :iconType="iconType" :hideNode="hideNode"></header-float>
            <div class="imgWrap">
                <p>请上传真实、清晰的行驶证</p>
                <img src="../../assets/images/addcar.jpg" alt="">
            </div>
        </div>
        <select-car v-if="$store.state.comm.hasCarSelectSHow"></select-car>
    </div>
</template>

<script>
import headerCommon from '../../components/header/headerCommon.vue'
import headerFloat from '../../components/header/headerFloat.vue'
import selectCar from '../carSelectSeries.vue'
import {Picker, Toast, DatetimePicker} from 'mint-ui'
import upload from '../../../static/js/upload.js'
import ports from './../../port.js'
import ajax from './../../vueResource.ajax.js'

export default {
    data () {
        return {
            viewTitle: '添加车辆',
            iconType: 'icon-fanhui',
            rightParams: {},
            hideNode: 'hidecarFloor',
            slots: [{
                flex: 1,
                values: [ '京', '津', '冀', '晋', '蒙', '辽', '吉', '黑', '沪', '苏',
                    '浙', '皖', '闽', '赣', '鲁', '豫', '鄂', '湘', '粤', '桂', '琼', '川', '贵',
                    '云', '渝', '藏', '陕', '甘', '青', '宁', '新', '港', '澳', '台'],
                textAlign: 'center'
            }],
            hasAreaPicker: 1,
            // selArea 车牌省
            selArea: '浙',
            // selAreaTmp 滚动的时候 临时存储车牌省
            selAreaTmp: '',
            // areaNum 车牌输入
            areaNum: '',
            // 当前打开的datepicker
            curPicker: '',
            // inspectModel 年检
            inspectModel: '',
            inspectData: new Date(),
            // insuranceModel 保险
            insuranceModel: '',
            insuranceData: '',
            startDate: new Date(),
            isShow: 1,
            // 车款ID
            carID: this.$store.state.comm.addCarID,
            // 当前选择的车款数据
            carData: {},
            // 车架号
            frameNumber: '',
            // 车主认证
            cardID1: '1',
            cardID2: '1',
            cardURL1: '',
            cardURL2: '',
            // 总里程数
            mile: '',
            // 日行驶
            mileData: '',
            // 隐显变量
            hasCarSelectSHow: false
        }
    },
    components: {
        'header-common': headerCommon,
        'header-float': headerFloat,
        'mt-picker': Picker,
        'mt-datetime-picker': DatetimePicker,
        'select-car': selectCar
    },
    computed: {
        selectCurId () {
            return this.$store.state.comm.addCarID
        }
    },
    beforeCreate () {
        this.$store.commit('hideFoot')
    },
    beforeDestroy () {
        this.$store.state.comm.addCarID = ''
    },
    created () {
    },
    watch: {
        selectCurId (val, old) {
            console.log(val)
            ajax.ajax({
                'vue': this,
                'port': 'GetCarDetailByCarId',
                'type': 'get',
                'params_url': '?carId=' + this.selectCurId,
                'statusOk': function (res, v) {
                    // v.$store.commit('setUserInfo', res.data.data)
                    if (res.data.success) {
                        v.carData = res.data.data
                    }
                },
                'statusError': function (res, v) {
                    Toast('获取车款信息失败')
                }
            })
        }
    },
    methods: {
        onlySZ (val) {
            if (val === 1) {
                this.mile = this.mile.replace(/[^0-9]/g, '')
            } else {
                this.mileData = this.mileData.replace(/[^0-9]/g, '')
            }
        },
        onSelectAreaOpen () {
            this.hasAreaPicker = 0
        },
        onSelectAreaClose (val) {
            this.hasAreaPicker = 1
            if (val === 0) {
                this.selArea = this.selAreaTmp
                var areaArr = this.slots[0].values
                for (var i = 0; i < areaArr.length; i++) {
                    if (areaArr[i] === this.selAreaTmp) {
                        // 设置picker默认位置
                        this.slots[0].defaultIndex = i
                    }
                }
            }
        },
        onAreaInputBlur () {
            // console.log(this.areaNum)
            var reg = /^[0-9a-zA-Z]*$/g
            if (!reg.test(this.areaNum) || !this.areaNum) {
                Toast('车牌号码输入不正确')
            } else {
                var ftxt = this.areaNum.charAt(0)
                ftxt = ftxt.toUpperCase()
                this.areaNum = ftxt + '·' + this.areaNum.substring(1)
            }
        },
        onAreaInputFocus () {
            if (this.areaNum) {
                var tmp = this.areaNum.split('·')
                this.areaNum = tmp[0] + tmp[1]
            }
        },
        onAreaInputKeyup () {
            // var re = /^[A-Z]{1}[A-Z_0-9]{5}$/
            if (this.areaNum.length > 6) {
                Toast('车牌号码不得超过6位')
            }
        },
        onOpenAreaPicker (val) {
            // 0 保险 1 年检
            this.$refs.picker.open()
            this.curPicker = val
        },
        onAreaChange (picker, val) {
            this.selAreaTmp = val[0]
        },
        confirmDatePicker (val) {
            var date = new Date(val)
            var month = parseInt(date.getMonth()) + 1
            if (this.curPicker === 0) {
                this.insuranceModel = date.getFullYear() + '-' + month + '-' + date.getDate()
                this.insuranceData = new Date(this.insuranceModel)
                // this.insuranceData = Date.parse(new Date(this.insuranceModel))
            } else {
                this.inspectModel = date.getFullYear() + '-' + month + '-' + date.getDate()
                // this.inspectData = Date.parse(new Date(this.inspectModel))
                this.inspectData = new Date(this.inspectModel)
            }
        },
        closeDataPicker () {
        },
        onOpen () {
            this.$store.commit('showCarFloor')
        },
        onClose () {
            this.$store.commit('hideCarFloor')
        },
        onUpload (fm, id) {
            var formdata = new window.FormData(fm)
            var that = this
            upload.upload(formdata, ports.port.PictureUploadForView, function (val) {
                val = JSON.parse(val)
                if (val.success === true) {
                    console.log(val.data[0].url)
                    if (id === 1) {
                        that.cardID1 = val.data[0].id
                        that.cardURL1 = val.data[0].url
                    } else {
                        that.cardID2 = val.data[0].id
                        that.cardURL2 = val.data[0].url
                    }
                    Toast('上传成功')
                } else {
                    Toast('上传失败')
                }
            })
        },
        onSubmit () {
            console.log(this.carId)
            if (!this.$store.state.comm.addCarID) {
                Toast('请选择车款')
                return
            }
            if (!this.areaNum) {
                Toast('请填写车牌号')
                return
            }
            if (!this.frameNumber) {
                Toast('请填写车架号')
                return
            }
            if (!this.mile) {
                Toast('请填写总公里数')
                return
            }
            if (!this.mileData) {
                Toast('请填写日行驶公里数')
                return
            }
            if (!this.insuranceModel) {
                Toast('请选择保险到期时间')
                return
            }
            if (!this.inspectModel) {
                Toast('请选择年检提醒时间')
                return
            }
            if (!this.cardID1 || !this.cardID1) {
                Toast('请上传行驶证')
                return
            }
            var tmp = this.areaNum.split('·')
            this.areaNum = tmp[0] + tmp[1]
            var params = {
                'carId': this.$store.state.comm.addCarID,
                'licensePlate': this.areaNum,
                'frameNumber': this.frameNumber,
                'totalKm': this.mile,
                'dayKm': this.mileData,
                carInsuranceRemind: this.insuranceData,
                annualInspection: this.inspectData,
                'pictureId1': this.cardID1,
                'pictureId2': this.cardID2,
                'isDefault': false,
                'describe': '',
                'remark': ''
            }
            ajax.ajax({
                'vue': this,
                'port': 'CreateCustomerCar',
                'type': 'post',
                'req_params': params,
                'statusOk': function (res, v) {
                    console.log(res)
                    if (res.data.success === true) {
                        Toast('添加车辆信息成功')
                        // v.$router.push('/user/carList')
                        v.$router.back()
                    }
                },
                'statusError': function (res, v) {
                    Toast('添加车辆信息失败')
                }
            })
        }
    }
}
</script>

<style lang="stylus" rel="stylesheet/stylus">
#addCarInfo
    #addCarInfoWrap
        margin-top:55px
        margin-bottom:80px
        .info
            margin-top:15px
            width:100%
            background-color:#fff
            border-bottom:1px solid #ddd
            .carName
                height:60px
                line-height:60px
                p
                    line-height:58px
                label
                    width:100%
                img
                    width:40px
                    height:40px
                    display:inline-block
                    vertical-align: middle
                span
                    display:inline-block
                    width:75%
                    height:60px
                    white-space:nowrap
                    overflow:hidden
                    text-overflow:ellipsis
                    vertical-align: middle
            .carNum
                .carNumWrap
                    display:inline-block
                    width:125px
                    height:36px
                    border:none
                    vertical-align: middle
                    margin-left:0
                    background:url(../../assets/images/bg_carID.png) no-repeat
                    background-size:100% 100%
                    color: #fff
                    span
                        display:inline-block
                        line-height:36px
                        text-align:center
                        width:40px
                        height:36px
                        vertical-align:top
                        background:url(../../assets/images/icon_sanxia.png) no-repeat
                        background-position:33px 12px
                    input
                        background:none
                        height:36px
                        width:77px
                        float:right
                        margin-right:3px
                        color:#fff
                        overflow:hidden
            .rz
                height:60px
                line-height:60px
                label
                    i
                        color:#dab96e
                span
                    display:inline-block
                    width:67px
                    height:41px
                    background:url(../../assets/images/icon_addbox.png) no-repeat
                    background-size:100% 100%
                    vertical-align:middle
                    color:#bbb
                    font-size:12px
                    text-align:center
                    line-height:60px
                    position:relative
                    img
                        display:block
                        position:absolute
                        top:0
                        left:0
                        z-index:0
                        width:90%
                        height:36px
                        background-color:#fff
                        margin:5%
                    form
                        width:67px
                        height:40px
                        position:absolute
                        left:0
                        top:0
                        input
                            width:67px
                            height:40px
                            vertical-align:top
                            opacity: 0
            div
                height:45px
                line-height:45px
                margin-left:10px
                border-bottom:1px solid #ddd
                position:relative
                &:last-child
                    border-bottom:none
                &:before
                    position:absolute
                    right:10px
                    color:#999
                label
                    display:inline-block
                    width:33%
                    color:#999
                input
                    display:inline-block
                    width:60%
                    height:44px
        .btnWrap
            position:fixed
            bottom:0
            width:100%
            background-color:#fff
            z-index:2
            .charge
                width: 94%
                margin: 20px 3% 10px 3%
                background-color: #c7a770
                height: 44px
                line-height: 44px
                color: #fff
                border: none
                font-size: 18px
    .sex-picker
        width:100%
        height:100%
        position:fixed
        bottom:0
        z-index:5
        .mask
            position:absolute
            height:100%
            width:100%
            background-color:rgba(0,0,0,0.5)
        .pickWrap
            position:absolute
            bottom:0
            width:100%
            z-index:2
            background-color:#fff
            .opwrap
                overflow:hidden
                border-bottom:1px solid #ddd
                span
                    display:block
                    float:left
                    width:50%
                    color:#26a2ff
                    height:40px
                    line-height:40px
                    text-align:center
    .uploadExp
        position:fixed
        width:100%
        height:100%
        top:0
        background-color:#353535
        z-index:6
        .imgWrap
            height:300px
            font-size:16px
            color:#fff
            vertical-align:middle
            margin-top:120px
            text-align:center
            img
                width:94%
                margin:10px 3%
</style>
