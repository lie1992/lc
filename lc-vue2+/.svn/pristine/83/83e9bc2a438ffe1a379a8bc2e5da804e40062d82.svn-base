<template lang="html">
    <div id="order" >
        <header-common :title="viewTitle" :iconType="iconType" :rightParams="rightParams"></header-common>
        <div class="orderWrap">
            <mt-navbar  v-model="selected">
                <mt-tab-item id="1">全部</mt-tab-item>
                <mt-tab-item id="2">待处理</mt-tab-item>
                <mt-tab-item id="3">已完成</mt-tab-item>
            </mt-navbar>
            <mt-tab-container :swipeable="swipeable" v-model="selected">
                <mt-tab-container-item id="1">
                    <div class="list" >
                        <div class="slideBar" ref="slideBar1">
                            <!--  -->
                            <div class="orderItem" v-for="order in orderList">
                                <div class="status" @click="showOrder(order.id)">订单时间:<span>{{order.createOn}}</span><span class="orderStatus">{{order.orderDisplayStatus}}</span><span class="more iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></div>
                                <div  v-for="item in order.orderServices">
                                    <div class="ttl">{{item.productName}}<span>耗时<em>{{item.unitDuration}}小时</em>服务费<em>￥{{item.unitTotalPrice}}</em></span></div>
                                    <div class="itemWrap">
                                        <div class="item">
                                            <div  v-for="pj in item.categories">
                                                <p class="tt"><span class="name">{{pj.categoryName}}</span></p>
                                                <p class="tt2" v-for="pjdetail in pj.accessoryProducts"><span class="desc">{{pjdetail.productName}}</span><span class="cost">￥{{pjdetail.unitTotalPrice}}</span></p>
                                            </div>
                                        </div>
                                        <!-- <div class="item">
                                        <p class="tt"><span class="name">机油</span></p>
                                        <p class="tt2"><span class="desc">嘉实多机油(4L)</span><span class="cost">￥414</span></p>
                                        <p class="tt2"><span class="desc">嘉实多机油(4L)</span><span class="cost">￥414</span></p>
                                    </div> -->
                                </div>
                                </div>
                                <div class="hz">共{{order.accessoryProductCount}}个配件、{{order.serviceCount}}项服务 实付款：<em>￥{{order.totalAmount }}</em></div>
                                <div class="total">
                                    {{order.canFinalPay===false?'应付订金':'应付尾款'}}：<em>￥{{order.depositAmount}}</em>
                                    <div class="btnWrap">
                                        <button v-if="order.canCancel" @click="orderCancel(order)">取消订单</button>
                                        <button v-if="order.canOfflinePay" @click="OffPay(order)">线下付款</button>
                                        <button v-if="order.canPayOrder" @click="OrderPay(order)">立即付款</button>
                                        <button v-if="order.canEvaluate" @click="OrderComm(order)">评价</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </mt-tab-container-item>
                <mt-tab-container-item id="2">
                    <div class="list" >
                        <div class="slideBar"  ref="slideBar2">
                            <!--  -->
                            <div class="orderItem" v-for="order in orderList">
                                <div class="status" @click="$router.push('/order/'+order.id)">订单时间：<span>{{order.createOn}}</span><span class="orderStatus">{{order.orderDisplayStatus}}</span><span class="more iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></div>
                                <div  v-for="item in order.orderServices">
                                    <div class="ttl">{{item.productName}}<span>耗时<em>{{item.unitDuration}}小时</em>服务费<em>￥{{item.unitTotalPrice}}</em></span></div>
                                    <div class="itemWrap">
                                        <div class="item">
                                            <div  v-for="pj in item.categories">
                                                <p class="tt"><span class="name">{{pj.categoryName}}</span></p>
                                                <p class="tt2" v-for="pjdetail in pj.accessoryProducts"><span class="desc">{{pjdetail.productName}}</span><span class="cost">￥{{pjdetail.unitTotalPrice}}</span></p>
                                            </div>
                                        </div>
                                        <!-- <div class="item">
                                        <p class="tt"><span class="name">机油</span></p>
                                        <p class="tt2"><span class="desc">嘉实多机油(4L)</span><span class="cost">￥414</span></p>
                                        <p class="tt2"><span class="desc">嘉实多机油(4L)</span><span class="cost">￥414</span></p>
                                    </div> -->
                                </div>
                                </div>
                                <div class="hz">共{{order.accessoryProductCount}}个配件、{{order.serviceCount}}项服务 实付款：<em>￥{{order.totalAmount }}</em></div>
                                <div class="total">
                                    {{order.canFinalPay===false?'应付订金':'应付尾款'}}：<em>￥{{order.depositAmount}}</em>
                                    <div class="btnWrap">
                                        <button v-if="order.canCancel" @click="orderCancel(order)">取消订单</button>
                                        <button v-if="order.canOfflinePay" @click="OffPay(order)">线下付款</button>
                                        <button v-if="order.canPayOrder" @click="OrderPay(order)">立即付款</button>
                                        <button v-if="order.canEvaluate" @click="OrderComm(order)">评价</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </mt-tab-container-item>
                <mt-tab-container-item id="3">
                    <div class="list" >
                        <div class="slideBar"  ref="slideBar3">
                            <!--  -->
                            <div class="orderItem" v-for="order in orderList">
                                <div class="status" @click="$router.push('/order/'+order.id)">订单时间：<span>{{order.createOn}}</span><span class="orderStatus">{{order.orderDisplayStatus}}</span><span class="more iconfont icon-chevron-copy-copy-copy-copy-copy-copy"></span></div>
                                <div  v-for="item in order.orderServices">
                                    <div class="ttl">{{item.productName}}<span>耗时<em>{{item.unitDuration}}小时</em>服务费<em>￥{{item.unitTotalPrice}}</em></span></div>
                                    <div class="itemWrap">
                                        <div class="item">
                                            <div  v-for="pj in item.categories">
                                                <p class="tt"><span class="name">{{pj.categoryName}}</span></p>
                                                <p class="tt2" v-for="pjdetail in pj.accessoryProducts"><span class="desc">{{pjdetail.productName}}</span><span class="cost">￥{{pjdetail.unitTotalPrice}}</span></p>
                                            </div>
                                        </div>
                                        <!-- <div class="item">
                                        <p class="tt"><span class="name">机油</span></p>
                                        <p class="tt2"><span class="desc">嘉实多机油(4L)</span><span class="cost">￥414</span></p>
                                        <p class="tt2"><span class="desc">嘉实多机油(4L)</span><span class="cost">￥414</span></p>
                                    </div> -->
                                </div>
                                </div>
                                <div class="hz">共{{order.accessoryProductCount}}个配件、{{order.serviceCount}}项服务 实付款：<em>￥{{order.totalAmount }}</em></div>
                                <div class="total">
                                    <label v-if="order.orderDisplayStatus==='已完成'">订单金额：<em>￥{{order.totalAmount}}</em></label>
                                    <label v-else>{{order.canFinalPay===false?'应付订金':'应付尾款'}}：<em>￥{{order.depositAmount}}</em></label>
                                    <div class="btnWrap">
                                        <button v-if="order.canCancel" @click="orderCancel(order)">取消订单</button>
                                        <button v-if="order.canOfflinePay" @click="OffPay(order)">线下付款</button>
                                        <button v-if="order.canPayOrder" @click="OrderPay(order)">立即付款</button>
                                        <button v-if="order.canEvaluate" @click="OrderComm(order)">评价</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </mt-tab-container-item>
            </mt-tab-container>
            <orderDetailComp :curShowOrderId="curShowOrderId" v-if="detailToggle" v-on:closeOrderDetailInParent="closeDeatil"></orderDetailComp>
        </div>
    </div>
</template>

<script  type="text/ecmascript-6">
import Bscroll from 'better-scroll'
import headerCommon from 'components/header/headerCommon.vue'
import orderDetailComp from './orderDetailComp.vue'
import { Navbar, TabItem, TabContainer, TabContainerItem } from 'mint-ui'
import { Toast, MessageBox } from 'mint-ui'
import ajax from './../vueResource.ajax.js'

export default {
    data () {
        return {
            viewTitle: '订单',
            iconType: '',
            rightParams: {},
            swipeable: true,
            selected: '1',
            // 订单数据列表
            orderList: [],
            page: 1,
            isLoading: false,
            end: false,
            // 详情组件显示/隐藏
            detailToggle: false,
            // 当前查看的订单ID
            curShowOrderId: 0
        }
    },
    components: {
        'header-common': headerCommon,
        'mt-navbar': Navbar,
        'mt-tab-item': TabItem,
        'mt-tab-container': TabContainer,
        'mt-tab-container-item': TabContainerItem,
        orderDetailComp
    },
    created () {
        this.getOrderList(0, this.page)
        this.loadMore()
    },
    beforeDestroy () {
        window.removeEventListener('scroll',this.scrollRoll)
    },
    watch: {
        selected (cur, old) {
            console.log(cur)
            this.orderList = []
            this.end = false
            if (cur === '1') {
                this.page = 1
                this.getOrderList('0', this.page)
            } else if (cur === '2') {
                this.page = 1
                this.getOrderList('1', this.page)
            } else {
                this.page = 1
                this.getOrderList('2', this.page)
            }
        }
    },
    methods: {
        closeDeatil () {
            this.detailToggle = false
        },
        showOrder (id) {
            this.curShowOrderId = id
            this.detailToggle = true
        },
        loadMore () {
            var that = this
            // 上一步坐标 本次坐标
            var oldy, cury
            // 滚动条的高度
            window.addEventListener('scroll', function (event) {
                oldy = cury
                var scrollTop = document.body.scrollTop
                cury = scrollTop
                var clientHeight
                if (that.selected === '1') {
                    if (that.$refs.slideBar1) {
                        clientHeight = that.$refs.slideBar1.clientHeight
                    }
                } else if (that.selected === '2') {
                    if (that.$refs.slideBar2) {
                        clientHeight = that.$refs.slideBar2.clientHeight
                    }
                } else{
                    if (that.$refs.slideBar3) {
                        clientHeight = that.$refs.slideBar3.clientHeight
                    }
                }
                // console.log(clientHeight)
                if (oldy >= cury) {
                    return
                }
                if (!clientHeight) {
                    return
                }
                if (scrollTop + window.innerHeight >= clientHeight) {
                    if (that.selected === '1') {
                        that.getOrderList('0', that.page)
                    } else if (that.selected === '2') {
                        that.getOrderList('1', that.page)
                    } else {
                        that.getOrderList('2', that.page)
                    }
                }
            })
        },
        // 评价订单
        OrderComm (val) {
            this.$router.push('/comment?id=' + val.id)
        },
        // 线下付款
        OffPay (val) {
            // 修改里程
            MessageBox.prompt('请输入支付码', '').then(({ value, action }) => {
                console.log(value)
                var params = {
                    orderId: val.id,
                    // 支付码
                    technicianRandomCode: value
                }
                ajax.ajax({
                    'vue': this,
                    'port': 'OfflinePayOrder',
                    'type': 'post',
                    'req_params': params,
                    'statusOk': function (res, v) {
                        v.$router.push('/paySuccess?push=1')
                    },
                    'statusError': function (res, v) {
                        window.$.PageDialog.ok('操作失败，请稍后重试')
                    }
                })
            })
        },
        orderCancel (val) {
            if (val.canPayOrder === false) {
                window.$.PageDialog.ok('该订单暂时无法取消，请稍后再试')
                return false
            }
            ajax.ajax({
                'vue': this,
                'port': 'CancelOrder',
                'type': 'post',
                'req_params': {'orderId': val.id},
                'statusOk': function (res, v) {
                    if (v.selected === '1') {
                        val.canCancel = false
                        val.orderDisplayStatus = '已取消'
                        val.canPayOrder = false
                    } else {
                        for (var i = 0; i < v.orderList.length; i++) {
                            if (v.orderList[i].id === id) {
                                v.orderList.splice(i, 1)
                            }
                        }
                    }
                    val.canCancel = false
                    window.$.PageDialog.ok('取消订单成功')
                },
                'statusError': function (res, v) {
                    window.$.PageDialog.ok('取消订单失败')
                }
            })
        },
        OrderPay (val) {
            if (val.canPayOrder === false) {
                window.$.PageDialog.ok('当前订单处于'+ val.orderDisplayStatus+'状态，请稍后再支付')
                return false
            }
            if (wx) {
                var params = '?orderId=' + val.id + '&orderType=' + val.canFinalPay
                var path = encodeURIComponent('/index.html#/payment' + params)
                ajax.ajax({
                    'vue': this,
                    'port': 'GetRedirectUrl',
                    'type': 'get',
                    'params_url': '?path=' + path,
                    'statusOk': function (res, v) {
                        // window.alert(res.data.data)
                        window.location.href = res.data.data
                    },
                    'statusError': function (res, v) {
                        // window.$.PageDialog.ok('获取车款信息失败')
                    }
                })
            }
            // this.$router.push('/payment?orderId=' + val.id + '&orderType=' + val.canFinalPay )
        },
        // 获取订单列表
        getOrderList (type, page) {
            if (this.isLoading) {
                return
            }
            if (this.end === true) {
                return
            }
            this.isLoading = true
            ajax.ajax({
                'vue': this,
                'port': 'GetMyOrders',
                'type': 'get',
                'params_url': '?dto.queryOrderStatusId=' + type + '&dto.page=' + page + '&dto.pageSize=10',
                'statusOk': function (res, v) {
                    // console.log(res.data.data.length)
                    v.isLoading = false
                    if (res.data.data.length<=0) {
                        v.end = true
                        return
                    }
                    v.page ++
                    // console.log(res.data.data)
                    var dat = res.data.data
                    for (var i = 0; i < dat.length; i++) {
                        var date = new Date(dat[i].createOn)
                        var month = parseInt(date.getMonth()) + 1
                        var hours = date.getHours() > 8? date.getHours() - 8: 24 + date.getHours() -8
                        var minutes = date.getMinutes()
                        var seconds = date.getSeconds() >= 10?date.getSeconds():'0'+date.getSeconds()
                        dat[i].createOn = date.getFullYear() + '-' + month + '-' + date.getDate() + ' ' + hours +':'+ minutes +':'+ seconds
                    }

                    var pjNum = 0
                    for (var i = 0; i < dat.length; i++) {
                        var g1 = dat[i]
                        g1.serveNum = g1.orderServices.length
                    }
                    v.orderList = v.orderList.concat(res.data.data)
                    // v.orderList = res.data.data
                },
                'statusError': function (res, v) {
                    window.$.PageDialog.ok('修改失败')
                }
            })
        }

    },
    beforeCreate () {
        this.$store.commit('showFoot')
    }
}
</script>

<style lang="stylus" rel="stylesheet/stylus">
#order
    .orderWrap
        padding-top:45px
        .mint-navbar
            border-bottom:1px solid #ddd
            position: fixed
            top: 45px
            width: 100%
            z-index:10
            .mint-tab-item-label
                font-size:16px
                color:#666
        .mint-tab-item.is-selected
            border-color:#c7a770
            .mint-tab-item-label
                color:#c7a770
        .mint-tab-container
            position: relative
            margin-top: 45px
        .list
            .slideBar
                .orderItem
                    background-color:#fff
                    margin-top:10px
                    div
                        padding-left:10px
                        border-bottom:1px solid #ddd
                    .status
                        line-height:50px
                        color:#999
                        font-size:15px
                        position:relative
                        .more
                            position:absolute
                            right:1px
                            color:#333
                        span
                            color:#c7a770
                            font-size:14px
                        .orderStatus
                            float:right
                            margin-right:15px
                    .ttl
                        line-height:25px
                        padding: 15px 0
                        overflow:hidden
                        font-size:17px
                        span
                            float:right
                            font-size:15px
                            color:#999
                            em
                                font-style:normal
                                color:#c7a770
                                margin-right:10px
                                font-family:'微软雅黑'
                    .itemWrap
                        border-bottom:none
                        .item
                            min-height:50px
                            /*margin-left:25px*/
                            padding-bottom:5px
                            div
                                padding-bottom:3px
                                &:last-child
                                    border-bottom:none
                            &:last-child
                                border:none
                            .tt
                                /*float:left*/
                                width:100%
                                span
                                    display:block
                                    white-space:nowrap
                                    overflow:hidden
                                    text-overflow:ellipsis
                                .name
                                    line-height:30px
                                    margin-top:4px
                                    font-size:17px
                            .tt2
                                font-size:14px
                                color:#7d7d7d
                                overflow:hidden
                                .cost
                                    width:18%
                                    float:left
                                    text-align:center
                                .desc
                                    display:block
                                    float:left
                                    width:80%
                                    height:14px
                                    overflow:hidden
                    .hz
                        line-height:50px
                        text-align:right
                        padding-right:10px
                        color:#999
                        font-size:15px
                        em
                            font-style:normal
                            color:#c7a770
                            font-family:'微软雅黑'
                    .total
                        line-height:50px
                        .btnWrap
                            float:right
                            button
                                border:1px solid #aaa
                                background:none
                                height:32px
                                width:65px
                                padding:0
                                margin-right:5px
                                &:last-child
                                    color:#c7a770
                                    border-color:#c7a770
                        em
                            font-style:normal
                            color:#c7a770
                            font-family:'微软雅黑'







</style>
