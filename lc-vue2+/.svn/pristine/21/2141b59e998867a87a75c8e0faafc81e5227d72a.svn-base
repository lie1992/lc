<template lang="html">
    <!--  设置 -->
    <div id="setting">
        <header-common :title="viewTitle" :iconType="iconType" :rightParams="rightParams"></header-common>
        <div class="settingWrap">
            <div class="info">
                <div class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy" @click="$router.push('/user/changePassword')"><label>修改密码</label></div>
            </div>
            <div class="info">
                <div class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy" @click="clearCache"><label>清除缓存</label></div>
                <div class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy" @click="checkUpdate"><label>版本更新</label></div>
                <div class="iconfont icon-chevron-copy-copy-copy-copy-copy-copy" @click="$router.push('/aboutUs')"><label>关于我们</label> </div>
            </div>
            <div class="info">
                <div class="" @click="onLogout"><span>退出当前账号</span></div>
            </div>
        </div>
    </div>

</template>

<script>
import headerCommon from '../../components/header/headerCommon.vue'
import { Toast, MessageBox } from 'mint-ui'
import ajax from './../../vueResource.ajax.js'

export default {
    data () {
        return {
            viewTitle: '设置',
            iconType: 'icon-fanhui',
            rightParams: {},
            jgCode: ''
        }
    },
    components: {
        'header-common': headerCommon
    },
    beforeCreate () {
        window.scroll(0,0)
        this.$store.commit('hideFoot')
    },
    created () {
        var _ua = this.userAgent()
        if(_ua === "android"){
            this.jgCode = myJsObj.getRegistration()
        } else if(_ua === "ios"){

        }
    },
    methods: {
        checkUpdate () {
            if(this.userAgent() === "android"){
                ajax.ajax({
                    'vue': this,
                    'port': 'HasUpdate',
                    'type': 'get',
                    'params_url': '?version=' + window.versions,
                    'statusOk': function (res, v) {
                        MessageBox.confirm('发现新版本，是否立即更新?').then(action => {
                            window.location.href = ''
                        })
                    },
                    'statusError': function (res, v) {
                        window.$.PageDialog.ok('未发现新版本')
                    }
                })
            }else if(this.userAgent() === "ios"){
                window.$.PageDialog.ok('IOS未上线，敬请期待')
            }
        },
        userAgent() {
            var ua = navigator.userAgent.toLowerCase()
            var _ua = ""
            if (/iphone|ipad|ipod/.test(ua)) {
                _ua = "ios"
            } else if (/android/.test(ua)) {
                _ua = "android"
            }else{
                _ua = "web"
            }
            return _ua
        },
        onLogout () {
            // window.localStorage.clear()
            window.localStorage.removeItem('userToken')
            window.localStorage.removeItem('userName')
            this.$store.state.user.userToken = ''
            this.$store.state.user.userName = ''
            this.$store.state.user.userDefaultCar = {}
            this.$store.state.user.curCarID = ''
            window.$.PageDialog.ok('当前账号已退出登录')
            this.logoutSBM()
            this.$router.push('/index')
        },
        // 注销设备码
        logoutSBM () {
            ajax.ajax({
                'vue': this,
                'port': 'UnRegisterDevice',
                'type': 'post',
                'statusOk': function (res, v) {
                },
                'statusError': function (res, v) {
                }
            })
        },
        clearCache () {
            // window.localStorage.clear()
            // this.$store.state.user.userToken = ''
            // this.$store.state.user.userName = ''
            // this.$store.state.user.userDefaultCar = {}
            // this.$store.state.user.curCarID = ''
            if(this.userAgent() === "android"){
                var clean = myJsObj.cleanCache()
                // window.alert(clean)
            }else if(this.userAgent() === "ios"){
                window.webkit.messageHandlers.HybridKit.postMessage({"method": "clearCache"});
            }else{

            }
        }
    }
}
</script>

<style lang="stylus" rel="stylesheet/stylus">
#setting
    .settingWrap
        margin-top:55px
        .info
            margin-top:15px
            width:100%
            background-color:#fff
            border-bottom:1px solid #ddd
            div
                height:45px
                line-height:45px
                margin-left:10px
                border-bottom:1px solid #ddd
                position:relative
                &:last-child
                    border-bottom:none
                &:before
                    position:absolute
                    right:10px
                    color:#999
                label
                    display:inline-block
                    width:33%
                    color:#999
                input
                    display:inline-block
                    width:60%
                    height:44px
                span
                    text-align:center
                    display:block
                    margin-right:10px
                    color:#daba70
</style>
