<template lang="html">
    <!-- 保养计划表 -->
    <div id="plan">
        <header-common :title="viewTitle" :iconType="iconType" :rightParams="rightParams"></header-common>
        <div class="planWrap">
            <div class="CarInfo iconfont icon-chevron-copy-copy-copy-copy-copy-copy" @click="$router.push('/user/changeCurCar')">
                <div class="CarInfoWrap">
                    <div class="carLogo">
                        <img :src="defaultCarImg" >
                    </div>
                    <div class="carInfo">
                        <div class="carID">{{defaultCar.displayLicensePlate}} <span>{{defaultCar.totalKm}}公里</span></div>
                        <div class="carDesc">{{defaultCar.carName}}</div>
                    </div>
                </div>
            </div>
            <div class="mileage">
                <div class="bar">
                    <div class="circle"></div>
                    <!-- <div class="curCircle"></div> -->
                    <div class="circle"></div>
                    <div class="circle"></div>
                </div>
                <div class="disc">
                    <span>{{mile1}}公里</span>
                    <span>{{mile2}}公里</span>
                    <span>{{mile3}}公里</span>
                </div>
                <mt-range v-model="rangeValue" :min="1" :max="3" :step="1" :bar-height="5"></mt-range>
            </div>
            <div class="project">
                <div class="tt">保养项目</div>
                <div class="itemWrap">
                    <div class="item" v-if="realData" v-for="item in realData"  @click="$router.push('/serveIntroduce/' + item.serviceProductId )"><img :src="item.serviceIconPictureUrl" alt=""><span>{{item.serviceProductName}}</span></div>
                    <!-- <div class="item"><img src="../assets/images/icon_plan1.png" alt="">小保养</div>
                    <div class="item"><img src="../assets/images/icon_plan2.png" alt="">大保养</div>
                    <div class="item"><img src="../assets/images/icon_plan3.png" alt="">车辆检测</div>
                    <div class="item"><img src="../assets/images/icon_plan4.png" alt="">换空调滤</div>
                    <div class="item"><img src="../assets/images/icon_plan5.png" alt="">换火花塞</div>
                    <div class="item"><img src="../assets/images/icon_plan6.png" alt="">换轮胎</div>
                    <div class="item"><img src="../assets/images/icon_plan7.png" alt="">四轮定位</div>
                    <div class="item"><img src="../assets/images/icon_plan8.png" alt="">换刹车盘片</div>
                    <div class="item"><img src="../assets/images/icon_plan9.png" alt="">换正时皮带</div>
                    <div class="item"><img src="../assets/images/icon_plan10.png" alt="">换防冻液</div>
                    <div class="item"><img src="../assets/images/icon_plan11.png" alt="">换蓄电池</div>
                    <div class="item"><img src="../assets/images/icon_plan12.png" alt="">换灯泡</div> -->
                </div>
            </div>
            <div class="btnWrap">
                <button class="charge" @click="addCarts">立即保养</button>
            </div>
        </div>
    </div>
</template>

<script>
import headerCommon from '../components/header/headerCommon.vue'
import { Range, Toast } from 'mint-ui'
import ajax from './../vueResource.ajax.js'

export default {
    data () {
        return {
            viewTitle: '保养计划表',
            iconType: 'icon-fanhui',
            rightParams: {},
            rangeValue: 2,
            // params ID
            paramsID: '',
            mile1: 0,
            mile2: 0,
            mile3: 0,
            data1: {},
            data2: {},
            data3: {},
            // 保养服务列表
            realData: [],
            // 车辆图片
            defaultCarImg: ''
        }
    },
    components: {
        'header-common': headerCommon,
        'mt-range': Range
    },
    beforeCreate () {
        window.scroll(0,0)
        this.$store.commit('hideFoot')
    },
    destroyed () {
        // 销毁curCarID
        this.$store.state.user.curCarID = ''
    },
    computed: {
        defaultCar () {
            return this.$store.state.user.userDefaultCar
        }
    },
    created () {
        this.getdData()
        // this.getBYPlan()
    },
    watch: {
        rangeValue (v1, v2) {
            this.changeBYPlan()
        },
        defaultCar () {
            this.getBYPlan()
        }
    },
    methods: {
        // 获取车辆图片
        getDefaultCarImg () {
            ajax.ajax({
                'vue': this,
                'port': 'GetCarPicture',
                'type': 'get',
                'params_url': '?carId=' + this.defaultCar.carId,
                'statusOk': function (res, v) {
                    // console.log(res.data.data)
                    v.defaultCarImg = res.data.data
                },
                'statusError': function (res, v) {
                }
            })
        },
        // 批量添加购物车
        addCarts () {
            var arr = []
            for (var i = 0; i < this.realData.length; i++) {
                arr.push(this.realData[i].serviceProductId)
            }

            var params = {
                customerCarId: this.defaultCar.id,
                serviceProductIds: arr,
                countyId: this.$store.state.user.curAreaID,
                longitude: window.sessionStorage.lng,
                latitude: window.sessionStorage.lat
            }
            ajax.ajax({
                'vue': this,
                'port': 'AddServiceProductsToCart',
                'type': 'post',
                'req_params': params,
                'statusOk': function (res, v) {
                    var tmpdata = res.data.data
                    window.$.PageDialog.ok('已添加可用服务')
                },
                'statusError': function (res, v) {
                    window.$.PageDialog.ok(res.data.errorMessage)
                }
            })
        },
        getdData () {
            var carID = this.$route.query.id
            this.paramsID = carID
            if (this.$store.state.user.curCarID) {
                console.log(1)
                this.getDefaultCarInfo()
            } else if (carID) {
                console.log(2)
                this.getCarList()
            } else {
                console.log(3)
                this.getBYPlan()
            }
        },
        getDefaultCarInfo () {
            if (!this.$store.state.user.curCarNum) {
                ajax.ajax({
                    'vue': this,
                    'port': 'GetDefaultCustomerCar',
                    'type': 'get',
                    'statusOk': function (res, v) {
                        v.$store.state.user.userDefaultCar = res.data.data
                        v.$store.state.user.curCarNum = v.$store.state.user.userDefaultCar.displayLicensePlate
                        v.getBYPlan()
                    },
                    'statusError': function (res, v) {
                    }
                })
            } else {
                var listData = this.$store.state.user.userCarList
                var curCarID = this.$store.state.user.curCarID
                for (var i = 0; i < listData.length; i++) {
                    if (listData[i].id === curCarID) {
                        this.$store.state.user.userDefaultCar = listData[i]
                        this.getBYPlan()
                    }
                }
            }
        },
        getCarList () {
            ajax.ajax({
                'vue': this,
                'port': 'GetCustomerCars',
                'type': 'get',
                'statusOk': function (res, v) {
                    var tmpdata = res.data.data
                    v.carList = tmpdata
                    // 保存车辆列表
                    v.$store.state.user.userCarList = tmpdata
                    // 使用当前ID获取车辆数据
                    for (var i = 0; i < tmpdata.length; i++) {
                        if (parseInt(tmpdata[i].id) === parseInt(v.paramsID)) {
                            v.$store.state.user.userDefaultCar = tmpdata[i]
                        }
                    }
                },
                'statusError': function (res, v) {
                }
            })
        },
        // 获取保养手册
        getBYPlan () {
            this.getDefaultCarImg()
            console.log('getBYPlan')
            ajax.ajax({
                'vue': this,
                'port': 'GetMaintenanceTips',
                'type': 'get',
                'statusOk': function (res, v) {
                    var tmpdata = res.data.data
                    console.log(tmpdata)
                    var totalKM = v.defaultCar.totalKm
                    for (var i = 0; i < tmpdata.length; i++) {
                        if (tmpdata[i].startKilometers < totalKM && tmpdata[i].endKilometers >= totalKM) {
                            console.log(tmpdata[i])
                            v.data1 = tmpdata[i - 1]
                            v.data2 = tmpdata[i]
                            v.data3 = tmpdata[i + 1]
                            if (v.data1) {
                                v.mile1 = v.data1.endKilometers
                            }
                            if (v.data2) {
                                v.mile2 = v.data2.endKilometers
                            }
                            if (v.data3) {
                                v.mile3 = v.data3.endKilometers
                            }
                            v.changeBYPlan()
                            break
                        }
                    }
                },
                'statusError': function (res, v) {
                    // window.$.PageDialog.ok('保养手册不存在')
                }
            })
        },
        changeBYPlan () {
            // console.log(this.data2)
            // console.log(this.data3)
            switch (this.rangeValue) {
            case 1:
                console.log(this.data1)
                if (this.data1) {
                    this.realData = this.data1.serviceProducts
                } else {
                    this.realData = []
                }
                break
            case 2:
                console.log(this.data2)
                if (this.data2) {
                    this.realData = this.data2.serviceProducts
                } else {
                    this.realData = []
                }
                break
            case 3:
                if (this.data3) {
                    this.realData = this.data3.serviceProducts
                } else {
                    this.realData = []
                }
            }
        }
    }
}
</script>

<style lang="stylus" rel="stylesheet/stylus">
bg-img($url)
    background-image: url($url+".png")
#plan
    .planWrap
        margin-top:45px
        margin-bottom:80px
        .CarInfo
            width:100%
            height:90px
            background-color:#fff
            position:relative
            border-bottom:1px solid #ddd
            /*margin-bottom:10px*/
            &:before
                width:30px
                height:90px
                position:absolute
                right:0
                text-align:center
                line-height:90px
                color:#999
            .CarInfoWrap
                padding-left:70px
                overflow:hidden
                .carLogo
                    position:absolute
                    top:15px
                    left:0
                    width:40px
                    height:40px
                    padding:10px
                    float:left
                    img
                        margin:0 auto
                        max-width:100%
                .carInfo
                    float:left
                    width:100%
                    font-family:"微软雅黑"
                    position:relative
                    .carID
                        margin:15px 0
                        width:105px
                        height:32px
                        bg-img("../assets/images/bg_carID")
                        background-size: 100% 100%
                        font-family:"微软雅黑"
                        font-size:15px
                        letter-spacing: 1px
                        color:#fff
                        text-align:center
                        line-height:32px
                        position:relative
                        span
                            display:block
                            width:80px
                            position:absolute
                            top:0
                            right:-80px
                            color:#999
                            letter-spacing: 0
                    .carDesc
                        font-family:"微软雅黑"
                        color:#999
                        font-size:14px
                        height:16px
                        letter-spacing: 1px
                        overflow:hidden
                        white-space:nowrap
                        text-overflow:ellipsis
                        padding-right:30px
        .mileage
            height:90px
            margin-top:30px
            position:relative
            .mt-range
                position:absolute
                width:68%
                left:16%
                top:-3px
                .mt-range-thumb
                    width:50px
                    height:50px
                    text-align:center
                    background:url(../assets/images/icon_plancar.png)no-repeat
                    background-size:50px
                    background-position:center
                    margin-top:-13px
                    margin-left:-10px
                    box-shadow:none
            .mt-range-runway
                border-top-style:none
                border-top-color:rgba(255,255,255,0)
            .mt-range-progress
                background:none
            .bar
                height:21px
                background:url(../assets/images/icon_rode.png)no-repeat
                background-size:100% 100%
                display:block
                div
                    /*height: 30px*/
                    float:left
                .circle
                    /*flex:1*/
                    display:block
                    float:left
                    width:33%
                    height:22px
                    background:url(../assets/images/icon_yuan.png)no-repeat
                    background-size:16px
                    background-position:center center
                    /*&:first-child
                        background-position:right 2px
                    &:last-child
                        background-position:left 2px*/
                .curCircle
                    width:50%
                    height:50px
                    text-align:center
                    background:url(../assets/images/icon_plancar.png)no-repeat
                    background-size:50px
                    background-position:center
                    margin-top:-15px
            .disc
                margin-top:20px
                text-align:center
                display:block
                span
                    /*flex:1*/
                    display:block
                    float:left
                    width:33%
                    text-align:center
                    /*width:25%*/
        .project
            background-color:#fff
            .tt
                padding-left:2.5%
                height:40px
                line-height:40px
                border-top:1px solid #ddd
                border-bottom:1px solid #ddd
            .itemWrap
                padding-left:2.5%
                padding-top:10px
                overflow:hidden
                .item
                    width:30%
                    height:70px
                    float:left
                    font-size:15px
                    text-align:center
                    color:#020202
                    border:1px solid #999
                    margin-right:2.5%
                    margin-bottom:6px
                    span
                        display:inline-block
                        width:90%
                        margin: 0 auto
                        height:30px
                        overflow:hidden
                    img
                        display:block
                        margin:3px auto
                        width:28px
                        height:28px
        .btnWrap
            position:fixed
            bottom:0
            width:100%
            background-color:#fff
            z-index:2
            .charge
                width: 94%
                margin: 20px 3% 10px 3%
                background-color: #c7a770
                height: 44px
                line-height: 44px
                color: #fff
                border: none
                font-size: 18px




</style>
