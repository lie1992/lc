<template lang="html">
    <div id="order" >
        <header-common :title="viewTitle" :iconType="iconType" :rightParams="rightParams"></header-common>
        <div class="orderWrap">
            <mt-navbar  v-model="selected">
                <mt-tab-item id="1">全部</mt-tab-item>
                <mt-tab-item id="2">待处理</mt-tab-item>
                <mt-tab-item id="3">已完成</mt-tab-item>
            </mt-navbar>
            <mt-tab-container :swipeable="swipeable" v-model="selected">
                <mt-tab-container-item id="1">
                    <div class="list">
                        <div class="slideBar">
                            <!--  -->
                            <div class="orderItem" v-for="order in orderList">
                                <div class="status" @click="$router.push('/order/'+order.id)">订单时间：<span>{{order.createOn}}</span><span class="orderStatus">{{order.orderDisplayStatus}}</span></div>
                                <div  v-for="item in order.orderServices">
                                    <div class="ttl">定期小保养<span>耗时<em>45分钟</em>服务费<em>￥90</em></span></div>
                                    <div class="itemWrap">
                                        <div class="item">
                                            <div  v-for="pj in item.categories">
                                                <p class="tt"><span class="name">{{pj.categoryName}}</span></p>
                                                <p class="tt2" v-for="pjdetail in pj.accessoryProducts"><span class="desc">{{pjdetail.productName}}</span><span class="cost">￥{{pjdetail.unitTotalPrice}}</span></p>
                                            </div>
                                        </div>
                                        <!-- <div class="item">
                                        <p class="tt"><span class="name">机油</span></p>
                                        <p class="tt2"><span class="desc">嘉实多机油(4L)</span><span class="cost">￥414</span></p>
                                        <p class="tt2"><span class="desc">嘉实多机油(4L)</span><span class="cost">￥414</span></p>
                                    </div> -->
                                </div>
                                </div>
                                <div class="hz">共3个配件、1项服务 实付款：<em>￥{{order.totalAmount }}</em></div>
                                <div class="total">
                                    应付订金：<em>￥{{order.depositAmount}}</em>
                                    <div class="btnWrap"><button v-if="order.canCancel" @click="orderCancel(order)">取消订单</button><button v-if="order.orderDisplayStatus !=='已取消'" @click="OrderPay(order.id)">立即付款</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </mt-tab-container-item>
                <mt-tab-container-item id="2">
                    <div class="list">
                        <div class="slideBar">
                            <div class="orderItem" v-for="order in orderList">
                                <div class="status" @click="$router.push('/order/'+order.id)">订单时间：<span>{{order.createOn}}</span><span class="orderStatus">{{order.orderDisplayStatus}}</span></div>
                                <div class="ttl">定期小保养<span>耗时<em>45分钟</em>服务费<em>￥90</em></span></div>
                                <div class="itemWrap">
                                    <div class="item" v-for="item in order.orderServices">
                                        <div  v-for="pj in item.categories">
                                            <p class="tt"><span class="name">{{pj.categoryName}}</span></p>
                                            <p class="tt2" v-for="pjdetail in pj.accessoryProducts"><span class="desc">{{pjdetail.productName}}</span><span class="cost">￥{{pjdetail.unitTotalPrice}}</span></p>
                                        </div>
                                    </div>
                                    <!-- <div class="item">
                                        <p class="tt"><span class="name">机油</span></p>
                                        <p class="tt2"><span class="desc">嘉实多机油(4L)</span><span class="cost">￥414</span></p>
                                        <p class="tt2"><span class="desc">嘉实多机油(4L)</span><span class="cost">￥414</span></p>
                                    </div> -->
                                </div>
                                <div class="hz">共3个配件、1项服务 实付款：<em>￥{{order.totalAmount }}</em></div>
                                <div class="total">
                                    应付订金：<em>￥{{order.depositAmount}}</em>
                                    <div class="btnWrap"><button @click="orderCancel(order.id)">取消订单</button><button @click="OrderPay(order.id)">立即付款</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </mt-tab-container-item>
                <mt-tab-container-item id="3">
                    <div class="list">
                        <div class="slideBar">
                            <div class="orderItem" v-for="order in orderList">
                                <div class="status" @click="$router.push('/order/'+order.id)">订单时间：<span>{{order.createOn}}</span><span class="orderStatus">{{order.orderDisplayStatus}}</span></div>
                                <div class="ttl">定期小保养<span>耗时<em>45分钟</em>服务费<em>￥90</em></span></div>
                                <div class="itemWrap">
                                    <div class="item" v-for="item in order.orderServices">
                                        <div  v-for="pj in item.categories">
                                            <p class="tt"><span class="name">{{pj.categoryName}}</span></p>
                                            <p class="tt2" v-for="pjdetail in pj.accessoryProducts"><span class="desc">{{pjdetail.productName}}</span><span class="cost">￥{{pjdetail.unitTotalPrice}}</span></p>
                                        </div>
                                    </div>
                                    <!-- <div class="item">
                                        <p class="tt"><span class="name">机油</span></p>
                                        <p class="tt2"><span class="desc">嘉实多机油(4L)</span><span class="cost">￥414</span></p>
                                        <p class="tt2"><span class="desc">嘉实多机油(4L)</span><span class="cost">￥414</span></p>
                                    </div> -->
                                </div>
                                <div class="hz">共3个配件、1项服务 实付款：<em>￥{{order.totalAmount }}</em></div>
                                <div class="total">
                                    应付订金:<em>￥{{order.depositAmount}}</em>
                                    <div class="btnWrap"><button @click="orderCancel(order.id)">取消订单</button><button @click="OrderPay(order.id)">立即付款</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </mt-tab-container-item>
            </mt-tab-container>

        </div>
    </div>
</template>

<script  type="text/ecmascript-6">
import Bscroll from 'better-scroll'
import headerCommon from 'components/header/headerCommon.vue'
import { Navbar, TabItem, TabContainer, TabContainerItem } from 'mint-ui'
import { Toast, MessageBox } from 'mint-ui'
import ajax from './../vueResource.ajax.js'

export default {
    data () {
        return {
            viewTitle: '订单',
            iconType: '',
            rightParams: {},
            swipeable: true,
            selected: '1',
            // 订单数据列表
            orderList: [],
            page: 1
        }
    },
    components: {
        'header-common': headerCommon,
        'mt-navbar': Navbar,
        'mt-tab-item': TabItem,
        'mt-tab-container': TabContainer,
        'mt-tab-container-item': TabContainerItem
    },
    created () {
        this.getOrderList(0, this.page)
    },
    watch: {
        selected (cur, old) {
            console.log(cur)
            if (cur === '1') {
                this.page = 1
                this.getOrderList('0', this.page)
            } else if (cur === '2') {
                this.page = 1
                this.getOrderList('1', this.page)
            } else {
                this.page = 1
                this.getOrderList('2', this.page)
            }
        }
    },
    methods: {
        orderCancel (val) {
            ajax.ajax({
                'vue': this,
                'port': 'CancelOrder',
                'type': 'post',
                'req_params': {'orderId': val.id},
                'statusOk': function (res, v) {
                    console.log(res.data.data)
                    if (this.selected === '1') {
                        val.canCancel = false
                        val.orderDisplayStatus = '已取消'
                    } else {
                        for (var i = 0; i < v.orderList.length; i++) {
                            if (v.orderList[i].id === id) {
                                v.orderList.splice(i, 1)
                            }
                        }
                    }
                    Toast('取消订单成功')
                },
                'statusError': function (res, v) {
                    Toast('取消订单失败')
                }
            })
        },
        OrderPay (id) {
            this.$router.push('/payment?orderId=' + id)
        },
        // 获取订单列表
        getOrderList (type, page) {
            ajax.ajax({
                'vue': this,
                'port': 'GetMyOrders',
                'type': 'get',
                'params_url': '?dto.queryOrderStatusId=' + type + '&dto.page=' + page + '&dto.pageSize=10',
                'statusOk': function (res, v) {
                    console.log(res.data.data)
                    var dat = res.data.data
                    for (var i = 0; i < dat.length; i++) {
                        var date = new Date(dat[i].createOn)
                        var month = parseInt(date.getMonth()) + 1
                        var hours = date.getHours() > 8? date.getHours() - 8: 24 + date.getHours() -8
                        var minutes = date.getMinutes()
                        var seconds = date.getSeconds() >= 10?date.getSeconds():'0'+date.getSeconds()
                        dat[i].createOn = date.getFullYear() + '-' + month + '-' + date.getDate() + ' ' + hours +':'+ minutes +':'+ seconds
                    }

                    var pjNum = 0
                    for (var i = 0; i < dat.length; i++) {
                        var g1 = dat[i]
                        g1.serveNum = g1.orderServices.length

                    }

                    v.orderList = res.data.data
                },
                'statusError': function (res, v) {
                    Toast('修改失败')
                }
            })
        }

    },
    beforeCreate () {
        this.$store.commit('showFoot')
    }
}
</script>

<style lang="stylus" rel="stylesheet/stylus">
#order
    .orderWrap
        padding-top:45px
        .mint-navbar
            border-bottom:1px solid #ddd
            .mint-tab-item-label
                font-size:16px
                color:#666
        .mint-tab-item.is-selected
            border-color:#c7a770
            .mint-tab-item-label
                color:#c7a770
        .list
            .slideBar
                .orderItem
                    background-color:#fff
                    margin-top:10px
                    div
                        padding-left:10px
                        border-bottom:1px solid #ddd
                    .status
                        line-height:50px
                        color:#999
                        font-size:15px
                        span
                            color:#c7a770
                        .orderStatus
                            float:right
                            margin-right:10px
                    .ttl
                        line-height:50px
                        font-size:17px
                        span
                            float:right
                            font-size:15px
                            color:#999
                            em
                                font-style:normal
                                color:#c7a770
                                margin-right:10px
                                font-family:'微软雅黑'
                    .itemWrap
                        border-bottom:none
                        .item
                            min-height:50px
                            margin-left:25px
                            padding-bottom:5px
                            div
                                padding-bottom:3px
                                &:last-child
                                    border-bottom:none
                            &:last-child
                                border:none
                            .tt
                                /*float:left*/
                                width:100%
                                span
                                    display:block
                                    white-space:nowrap
                                    overflow:hidden
                                    text-overflow:ellipsis
                                .name
                                    line-height:30px
                                    margin-top:4px
                                    font-size:17px
                            .tt2
                                font-size:14px
                                color:#7d7d7d
                                overflow:hidden
                                .cost
                                    width:18%
                                    float:left
                                    text-align:center
                                .desc
                                    display:block
                                    float:left
                                    width:80%
                    .hz
                        line-height:50px
                        text-align:right
                        padding-right:10px
                        color:#999
                        font-size:15px
                        em
                            font-style:normal
                            color:#c7a770
                            font-family:'微软雅黑'
                    .total
                        line-height:50px
                        .btnWrap
                            float:right
                            button
                                border:1px solid #aaa
                                background:none
                                height:32px
                                width:70px
                                margin-right:5px
                                &:last-child
                                    color:#c7a770
                                    border-color:#c7a770
                        em
                            font-style:normal
                            color:#c7a770
                            font-family:'微软雅黑'







</style>
