<template lang="html">
    <!--  优惠券 -->
    <div id="changeDiscount">
        <header-common :title="viewTitle" :iconType="iconType" :rightParams="rightParams" :paths="close" v-on:closeYHQ="closeYHQRel"></header-common>
        <div id="discountWrap">
            <div class="list">
                <div class="slideBar" ref="slideBar1">
                    <div class="item" v-for="item in ableData" data-id="item.campaignId" @click="selectDiscount(item)">
                        <div class="left">{{item.couponTypeId === 2? '￥':''}}<span>{{item.effectiveAmount}}</span>{{item.couponTypeId === 1? '折':''}}</div>
                        <div class="center"></div>
                        <div class="right">
                            <h4>{{item.couponTypeName}}</h4>
                            <p>1、满{{item.conditionAmount }}时可用</p>
                            <p>2、有效期至{{item.expiresOn.split('T')[0]}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
<script>
import headerCommon from '../../components/header/headerCommon.vue'
import ajax from './../../vueResource.ajax.js'
import Bscroll from 'better-scroll'
import { Navbar, TabItem, TabContainer, TabContainerItem, Toast, InfiniteScroll } from 'mint-ui'

export default {
    props: {
        discountServeID: {
            type: Number
        },
        discountServeType: {
            type: Number
        },
        selectArr: {
            type: Array
        }
    },
    data () {
        return {
            viewTitle: '优惠券',
            iconType: 'icon-fanhui',
            rightParams: {
                path: 'close',
                closeEmit: 'closeYHQ'
            },
            close: 'close',
            swipeable: false,
            selected: '1',
            // 可用数据
            ableData: [],
            // 不可用数据
            unAbleData: [],
            pageAble: 1,
            pageDisable: 1,
            // 是否在加载
            isLoading: false
        }
    },
    computed: {
        cartData () {
            return this.$store.state.cart.cartData
        },
        defaultCar () {
            return this.$store.state.user.userDefaultCar
        }
    },
    components: {
        'header-common': headerCommon,
        'mt-navbar': Navbar,
        'mt-tab-item': TabItem,
        'mt-tab-container': TabContainer,
        'mt-tab-container-item': TabContainerItem
    },
    beforeCreate () {
        // this.$store.commit('hideFoot')
    },
    created () {
        this.getDiscount(true, 1)
        this.loadMore()
    },
    methods: {
        // 选择优惠券
        selectDiscount (item) {
            this.discountServeID
            this.discountServeType
            var selDisArr = this.$store.state.cart.discountSeledList
            console.log(selDisArr)
            for (var i = 0; i < selDisArr.length; i++) {
                if (selDisArr[i] === item.id) {
                    Toast('该优惠券已被其他服务使用，请选择其他优惠券')
                    return false
                }
            }
            if (this.discountServeType === 2) {
                // 门店
                var mdData = this.$store.state.cart.cartConfirmMDData
                this.updataDiscountMD(mdData, item)
            } else {
                // 尚门
                var smData = this.$store.state.cart.cartConfirmSMData
                console.log(smData)
                this.updataDiscountSM(smData, item)
            }
            // this.$store.state.cart.discountSeledList.push(item.id)
            // this.$emit('closeYHQInParent')
        },
        updataDiscountSM (val, item) {
            var params = {
                "customerCarId": this.defaultCar.id,
                "shoppingCartItemIds": this.selectArr,
                "couponId": item.id,
                "addressId": val.addressId
            }
            ajax.ajax({
                'vue': this,
                'port': 'UpdateDoorToDoorPreOrder',
                'type': 'post',
                'req_params': params,
                'statusOk': function (res, v) {
                    console.log(res.data.data)
                    var smData = v.$store.state.cart.cartConfirmSMData
                    var selDisArr = v.$store.state.cart.discountSeledList
                    for (var i = 0; i < selDisArr.length; i++) {
                        console.log(selDisArr[i])
                        console.log(smData.discountID)
                        if (selDisArr[i] === smData.discountID) {
                            selDisArr.splice(i, 1);
                            console.log(selDisArr)
                        }
                    }
                    smData.discountID = item.id
                    selDisArr.push(item.id)
                    smData.discountName = item.couponTypeName + item.effectiveAmountName
                    v.$emit('closeYHQInParent')
                },
                'statusError': function (res, v) {
                    Toast(res.data.errorMessage)
                }
            })
        },
        updataDiscountMD (val, item) {
            console.log(item)
            var params = {
                "customerCarId": this.defaultCar.id,
                "shoppingCartItemIds": this.selectArr,
                "couponId": item.id,
                "storeId": this.discountServeID
            }
            ajax.ajax({
                'vue': this,
                'port': 'UpdateStorePreOrder',
                'type': 'post',
                'req_params': params,
                'statusOk': function (res, v) {
                    console.log(res.data.data)
                    var mdData = v.$store.state.cart.cartConfirmMDData
                    var selDisArr = v.$store.state.cart.discountSeledList
                    for (var i = 0; i < mdData.length; i++) {
                        if (mdData[i].storeId === v.discountServeID) {
                            for (var j = 0; j < selDisArr.length; j++) {
                                console.log(selDisArr[j])
                                console.log(mdData[i].discountID)
                                if (selDisArr[j] === mdData[i].discountID) {
                                    selDisArr.splice(j, 1);
                                    console.log(selDisArr)
                                }
                            }
                            mdData[i].discountID = item.id
                            selDisArr.push(item.id)
                            mdData[i].discountName = item.couponTypeName + item.effectiveAmountName
                        }
                    }
                    v.$emit('closeYHQInParent')
                },
                'statusError': function (res, v) {
                    Toast(res.data.errorMessage)
                }
            })
        },
        closeYHQRel () {
            this.$emit('closeYHQInParent')
        },
        loadMore () {
            var that = this
            // 上一步坐标 本次坐标
            var oldy, cury
            // 滚动条的高度
            window.addEventListener('scroll', function (event) {
                oldy = cury
                var scrollTop = document.body.scrollTop
                cury = scrollTop
                var clientHeight
                if (that.$refs.slideBar1) {
                    clientHeight = that.$refs.slideBar1.clientHeight
                }
                if (!clientHeight) {
                    return
                }
                if (oldy >= cury) {
                    return
                }
                if (scrollTop + window.innerHeight >= clientHeight) {
                    // 触发加载数据
                    that.getDiscount(true, that.pageAble)
                }
            })
        },
        getDiscount (val, page) {
            console.log(val, page)
            if (this.isLoading) {
                return
            }
            this.isLoading = true
            var params = '?dto.isUseable=' + val + '&dto.page=' + page + '&dto.pageSize=10'
            ajax.ajax({
                'vue': this,
                'port': 'GetCurrentCoupons',
                'type': 'get',
                'params_url': params,
                'statusOk': function (res, v) {
                    console.log(res.data)
                    v.isLoading = false
                    if (res.data.data.length <= 0) {
                        Toast('没有更多')
                        return
                    }
                    // Toast('加载成功')
                    v.ableData = v.ableData.concat(res.data.data)
                    v.pageAble ++

                },
                'statusError': function (res, v) {
                    Toast('获取折扣券失败')
                }
            })
        }
    }
}
</script>

<style lang="stylus" rel="stylesheet/stylus">
#changeDiscount
    position:absolute
    width:100%
    min-height:100%
    z-index:101
    top:0
    background-color:#f5f5f5
    #discountWrap
        margin-top:98px
        .list
            position:absolute
            top:50px
            bottom:10px
            z-index:-1
            width:100%
            /*overflow:hidden*/
            .slideBar
                padding-top:10px
                .item
                    margin:0 10px 10px 10px
                    /*height:102px*/
                    position:relative
                    padding-left:117px
                    div
                        height:102px
                    .left
                        position:absolute
                        left:0
                        top:0
                        background-color:#fff
                        width:100px
                        text-align:center
                        line-height:100px
                        border:1px solid #ddd
                        border-right:none
                        font-family:"微软雅黑"
                        font-size:13px
                        color:#c7a770
                        span
                            font-size:26px
                    .center
                        position:absolute
                        left:101px
                        top:0
                        background:url("../../assets/images/bg_disc2.png") no-repeat
                        background-size:17px 100px
                        width:17px
                    .right
                        background-color:#fff
                        border:1px solid #ddd
                        border-left:none
                        padding-left:15px
                        h4
                            margin-top:15px
                            margin-bottom:8px
                            font-size:20px
                            color:#666
                        p
                            color:#999
                            font-size:14px
                            line-height:20px
            .dated
                .list
                    .slideBar
                        .item
                            .left
                                color:#ccc
                                span
                                    color:#ccc
                            .right
                                h4
                                    color:#ccc
                                p
                                    color:#ccc


</style>
